<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>stack.blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://github.com/songMW/stack.github.io/"/>
  <updated>2018-05-22T07:35:01.172Z</updated>
  <id>https://github.com/songMW/stack.github.io/</id>
  
  <author>
    <name>stack</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Category</title>
    <link href="https://github.com/songMW/stack.github.io/2018/05/07/Objective-C/Category/"/>
    <id>https://github.com/songMW/stack.github.io/2018/05/07/Objective-C/Category/</id>
    <published>2018-05-07T07:07:43.000Z</published>
    <updated>2018-05-22T07:35:01.172Z</updated>
    
    <content type="html"><![CDATA[<h1 id="iOS底层原理"><a href="#iOS底层原理" class="headerlink" title="iOS底层原理"></a>iOS底层原理</h1><h2 id="预热"><a href="#预热" class="headerlink" title="预热"></a>预热</h2><ol><li><a href="#Category的本质">Category的本质是什么？</a></li><li><a href="#类别中添加实例">Category为什么只能加方法不能加属性？</a></li><li><a href="#Category中load方法">Category中有load方法吗？load方法是什么时候调用的？load 方法能继承吗？</a></li><li><a href="#如果多个分类中同时声明了相同的方法会如何调用">如果多个分类中同时声明了相同的方法会如何调用?</a></li></ol><h2 id="Category的本质"><a href="#Category的本质" class="headerlink" title="Category的本质"></a>Category的本质</h2><h3 id="引用网上的一段代码稍作修改"><a href="#引用网上的一段代码稍作修改" class="headerlink" title="引用网上的一段代码稍作修改"></a>引用网上的一段代码稍作修改</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Presen类 </span></div><div class="line"><span class="comment">// Presen.h</span></div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Preson</span> : <span class="title">NSObject</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> _age;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// Presen.m</span></div><div class="line"><span class="meta">#import <span class="meta-string">"Preson.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Preson</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Person - run"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">//Presen扩展</span></div><div class="line"><span class="comment">// Presen+Test.h</span></div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">"Preson.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">PersonDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@optional</span></div><div class="line">- (<span class="keyword">void</span>)delegateTest;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Preson</span> (<span class="title">Test</span>) &lt;<span class="title">NSCopying</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)<span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)<span class="keyword">id</span> &lt;PersonDelegate&gt; deleage;</div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line">+ (<span class="keyword">void</span>)abc;</div><div class="line">- (<span class="keyword">void</span>)setAge:(<span class="keyword">int</span>)age;</div><div class="line">- (<span class="keyword">int</span>)age;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// Presen+Test.m</span></div><div class="line"><span class="meta">#import <span class="meta-string">"Preson+Test.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Preson</span> (<span class="title">Test</span>)</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test</div><div class="line">&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)abc</div><div class="line">&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setAge:(<span class="keyword">int</span>)age</div><div class="line">&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">int</span>)age</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">10</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Person (Test) - run"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line">Presen分类<span class="number">2</span></div><div class="line"><span class="comment">// Preson+Test2.h</span></div><div class="line"><span class="meta">#import <span class="meta-string">"Preson.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Preson</span> (<span class="title">Test2</span>)</span></div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// Preson+Test2.m</span></div><div class="line"><span class="meta">#import <span class="meta-string">"Preson+Test2.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Preson</span> (<span class="title">Test2</span>)</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Person (Test2) - run"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure><h3 id="Category的底层结构"><a href="#Category的底层结构" class="headerlink" title="Category的底层结构"></a>Category的底层结构</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> _category_t &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;                              <span class="comment">// 类名</span></div><div class="line">    <span class="keyword">struct</span> _class_t *cls;                          <span class="comment">// 指向主类类对象的地址</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> _method_list_t *instance_methods; <span class="comment">// 实例方法列表</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> _method_list_t *class_methods;    <span class="comment">// 类方法列表</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> _protocol_list_t *protocols;      <span class="comment">// 协议列表</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> _prop_list_t *properties;         <span class="comment">// 属性列表</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>从Category的结构体中可以看到有实例方法列表，类方法列表，协议列表和属性列表。没有实例列表。<br>查看下_category_t 内部结构分别是什么？</p><h4 id="结构体中有一个-method-list-t-它是什么？"><a href="#结构体中有一个-method-list-t-它是什么？" class="headerlink" title="结构体中有一个 _method_list_t 它是什么？"></a>结构体中有一个 <code>_method_list_t</code> 它是什么？</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="comment">/*_method_list_t*/</span> &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</div><div class="line">    <span class="keyword">struct</span> _objc_method method_list[<span class="number">3</span>];</div><div class="line">&#125; _OBJC_$_CATEGORY_INSTANCE_METHODS_Person_$_Test __attribute__ ((used, section                 (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</div><div class="line">    <span class="keyword">sizeof</span>(_objc_method),</div><div class="line">    <span class="number">3</span>,</div><div class="line">    &#123;&#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"test"</span>, <span class="string">"v16@0:8"</span>, (<span class="keyword">void</span> *)_I_Person_Test_test&#125;,</div><div class="line">    &#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"setAge:"</span>, <span class="string">"v20@0:8i16"</span>, (<span class="keyword">void</span> *)_I_Person_Test_setAge_&#125;,</div><div class="line">    &#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"age"</span>, <span class="string">"i16@0:8"</span>, (<span class="keyword">void</span> *)_I_Person_Test_age&#125;&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="comment">/*_method_list_t*/</span> &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</div><div class="line">    <span class="keyword">struct</span> _objc_method method_list[<span class="number">1</span>];</div><div class="line">&#125; _OBJC_$_CATEGORY_CLASS_METHODS_Person_$_Test __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</div><div class="line">    <span class="keyword">sizeof</span>(_objc_method),</div><div class="line">    <span class="number">1</span>,</div><div class="line">    &#123;&#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">"abc"</span>, <span class="string">"v16@0:8"</span>, (<span class="keyword">void</span> *)_C_Person_Test_abc&#125;&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><ol><li>可以看出 <code>_method_list_t</code> 是保存实例方法与类方法的列表。</li><li>其结构体中存储了方法占用的内存，方法数量，以及方法列表。</li><li><code>_OBJC_$_CATEGORY_INSTANCE_METHODS_Person_$_Test</code> 是对象方法，与上文中声明的对象方法数量和名称对应一致。</li><li><code>_OBJC_$_CATEGORY_CLASS_METHODS_Person_$_Test</code> 是类方法，与上文中声明的类方法数量和名称对应一致。</li></ol><h4 id="属性列表"><a href="#属性列表" class="headerlink" title="属性列表"></a>属性列表</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> <span class="comment">/*_prop_list_t*/</span> &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _prop_t)</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count_of_properties;</div><div class="line">    <span class="keyword">struct</span> <span class="keyword">_prop_t</span> prop_list[<span class="number">2</span>];</div><div class="line">&#125; _OBJC_$_PROP_LIST_Person_$_Test __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</div><div class="line">    <span class="keyword">sizeof</span>(<span class="keyword">_prop_t</span>),</div><div class="line">    <span class="number">2</span>,</div><div class="line">    &#123;&#123;<span class="string">"age"</span>,<span class="string">"Ti,N"</span>&#125;,</div><div class="line">    &#123;<span class="string">"deleage"</span>,<span class="string">"T@\"&lt;PersonDelegate&gt;\",D,N"</span>&#125;&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><ol><li><code>_OBJC_$_PROP_LIST_Preson_$_Test</code>是属性列表结构体，存储属性的占用空间，属性数量，以及属性列表。</li><li><code>age, delegate</code> 是类中声明的属性。</li><li>类别中添加属性不会自动生成set，get方法，需要手动实现。</li></ol><h4 id="类别中添加实例"><a href="#类别中添加实例" class="headerlink" title="类别中添加实例"></a>类别中添加实例</h4><p>会报错  <code>Instance variables may not be placed in categories</code>;<br>原因：从Category的结构体中没有可以保存实例的列表。见<a href="#Category的底层结构">_category_t</a></p><h4 id="观察"><a href="#观察" class="headerlink" title="观察"></a>观察</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> _category_t &#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;                              <span class="comment">// 类名</span></div><div class="line">    <span class="keyword">struct</span> _class_t *cls;                          <span class="comment">// 指向主类类对象的地址</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> _method_list_t *instance_methods; <span class="comment">// 实例方法列表</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> _method_list_t *class_methods;    <span class="comment">// 类方法列表</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> _protocol_list_t *protocols;      <span class="comment">// 协议列表</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> _prop_list_t *properties;         <span class="comment">// 属性列表</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> _category_t _OBJC_$_CATEGORY_Person_$_Test __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = </div><div class="line">&#123;</div><div class="line">    <span class="string">"Person"</span>,</div><div class="line">    <span class="number">0</span>, <span class="comment">// &amp;OBJC_CLASS_$_Person,</span></div><div class="line">    (<span class="keyword">const</span> <span class="keyword">struct</span> _method_list_t *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_Person_$_Test,</div><div class="line">    (<span class="keyword">const</span> <span class="keyword">struct</span> _method_list_t *)&amp;_OBJC_$_CATEGORY_CLASS_METHODS_Person_$_Test,</div><div class="line">    <span class="number">0</span>,</div><div class="line">    (<span class="keyword">const</span> <span class="keyword">struct</span> _prop_list_t *)&amp;_OBJC_$_PROP_LIST_Person_$_Test,</div><div class="line">&#125;;</div></pre></td></tr></table></figure><p>上面两段代码是一一对应关系，分类源码中定义的对象方法，类方法，属性等都存放在catagory_t结构体中。</p><h3 id="catagory-t是如何将定义的方法，属性，协议等存储在类对象中的？"><a href="#catagory-t是如何将定义的方法，属性，协议等存储在类对象中的？" class="headerlink" title="catagory_t是如何将定义的方法，属性，协议等存储在类对象中的？"></a>catagory_t是如何将定义的方法，属性，协议等存储在类对象中的？</h3><p>查看<code>runtime</code>源码：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span></span></div><div class="line"><span class="bullet">* </span>map_images</div><div class="line"><span class="bullet">* </span>Process the<span class="markdown"> given images which </span>are<span class="markdown"> being mapped in by dyld.</span></div><div class="line"><span class="bullet">* </span>Calls ABI-agnostic code after taking ABI-specific locks.</div><div class="line"><span class="bullet">*</span></div><div class="line"><span class="bullet">* </span>Locking: write-locks runtimeLock</div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>/</div><div class="line"><span class="keyword">void</span> map_2_images(unsigned count, <span class="keyword">const</span> char * <span class="keyword">const</span> paths[], <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</div><div class="line">&#123;</div><div class="line">    rwlock_writer_t lock(runtimeLock);</div><div class="line">    <span class="keyword">return</span> map_images_nolock(count, paths, mhdrs);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span></span></div><div class="line"><span class="bullet">* </span><span class="emphasis">_read_</span>images</div><div class="line"><span class="bullet">* </span>Perform initial processing of the<span class="markdown"> headers in </span>the<span class="markdown"> linked </span></div><div class="line"><span class="bullet">* </span>list beginning with headerList. </div><div class="line"><span class="bullet">*</span></div><div class="line"><span class="bullet">* </span>Called by: map<span class="emphasis">_images_</span>nolock</div><div class="line"><span class="bullet">*</span></div><div class="line"><span class="bullet">* </span>Locking: runtimeLock acquired by map_images</div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>/</div><div class="line"><span class="keyword">void</span> _read_images(header_info **hList, uint32_t hCount, <span class="built_in">int</span> totalClasses, <span class="built_in">int</span> unoptimizedTotalClasses)</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    ...</div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="comment">// Discover categories. </span></div><div class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</div><div class="line">        category_t **catlist = _getObjc2CategoryList(hi, &amp;count);</div><div class="line">        <span class="built_in">bool</span> hasClassProperties = hi-&gt;info()-&gt;hasCategoryClassProperties();</div><div class="line">    </div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            category_t *cat = catlist[i];</div><div class="line">            Class cls = remapClass(cat-&gt;cls);</div><div class="line">    </div><div class="line">            <span class="keyword">if</span> (!cls) &#123;</div><div class="line">                <span class="comment">// Category's target class is missing (probably weak-linked).</span></div><div class="line">                <span class="comment">// Disavow any knowledge of this category.</span></div><div class="line">                catlist[i] = nil;</div><div class="line">                <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">                    _objc_inform(<span class="string">"CLASS: IGNORING category \?\?\?(%s) %p with "</span></div><div class="line">                    <span class="string">"missing weak-linked target class"</span>, </div><div class="line">                    cat-&gt;name, cat);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">    </div><div class="line">            <span class="comment">// Process this category. </span></div><div class="line">            <span class="comment">// First, register the category with its target class. </span></div><div class="line">            <span class="comment">// Then, rebuild the class's method lists (etc) if </span></div><div class="line">            <span class="comment">// the class is realized. </span></div><div class="line">            <span class="built_in">bool</span> classExists = NO;</div><div class="line">            <span class="keyword">if</span> (cat-&gt;instanceMethods || </div><div class="line">                cat-&gt;protocols       ||</div><div class="line">                cat-&gt;instanceProperties) &#123;</div><div class="line">                addUnattachedCategoryForClass(cat, cls, hi);</div><div class="line">                <span class="keyword">if</span> (cls-&gt;isRealized()) &#123;</div><div class="line">                    remethodizeClass(cls);</div><div class="line">                    classExists = YES;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">                    _objc_inform(<span class="string">"CLASS: found category -%s(%s) %s"</span>, cls-&gt;nameForLogging(), cat-&gt;name, classExists ? <span class="string">"on existing class"</span> : <span class="string">""</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">    </div><div class="line">            <span class="keyword">if</span> (cat-&gt;classMethods   || </div><div class="line">                cat-&gt;protocols      ||</div><div class="line">                (hasClassProperties &amp;&amp; </div><div class="line">                cat-&gt;_classProperties)) &#123;</div><div class="line">                </div><div class="line">                addUnattachedCategoryForClass(cat, cls-&gt;ISA(), hi);</div><div class="line">                <span class="keyword">if</span> (cls-&gt;ISA()-&gt;isRealized()) &#123;</div><div class="line">                    remethodizeClass(cls-&gt;ISA());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">                    _objc_inform(<span class="string">"CLASS: found category +%s(%s)"</span>, cls-&gt;nameForLogging(), cat-&gt;name);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>通过<code>_getObjc2CategoryList</code>函数获取到分类列表之后，进行遍历，获取其中的方法，协议，属性等。<br>最终调用了<code>remethodizeClass(cls)</code>函数</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/***********************************************************************</span></div><div class="line">* remethodizeClass</div><div class="line">* Attach outstanding categories to an existing class.</div><div class="line">* Fixes up cls's method list, protocol list, and property list.</div><div class="line">* Updates method caches for cls and its subclasses.</div><div class="line">* Locking: runtimeLock must be held by the caller</div><div class="line">**********************************************************************/</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> remethodizeClass(Class cls)</div><div class="line">&#123;</div><div class="line">    category_list *cats;</div><div class="line">    <span class="keyword">bool</span> isMeta;</div><div class="line"></div><div class="line">    runtimeLock.assertWriting();</div><div class="line"></div><div class="line">    isMeta = cls-&gt;isMetaClass();</div><div class="line"></div><div class="line">    <span class="comment">// Re-methodizing: check for more categories</span></div><div class="line">    <span class="keyword">if</span> ((cats = unattachedCategoriesForClass(cls, <span class="literal">false</span><span class="comment">/*not realizing*/</span>))) &#123;</div><div class="line">        <span class="keyword">if</span> (PrintConnecting) &#123;</div><div class="line">            _objc_inform(<span class="string">"CLASS: attaching categories to class '%s' %s"</span>, </div><div class="line">            cls-&gt;nameForLogging(), isMeta ? <span class="string">"(meta)"</span> : <span class="string">""</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        attachCategories(cls, cats, <span class="literal">true</span> <span class="comment">/*flush caches*/</span>);        </div><div class="line">        free(cats);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>源码中主要出现<code>attachCategories</code> ，看看它又是什么？<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Attach method lists and properties and protocols from categories to a class.</span></div><div class="line"><span class="comment">// Assumes the categories in cats are all loaded and sorted by load order, </span></div><div class="line"><span class="comment">// oldest categories first.</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> attachCategories(Class cls, category_list *cats, <span class="keyword">bool</span> flush_caches)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!cats) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (PrintReplacedMethods) printReplacements(cls, cats);</div><div class="line"></div><div class="line">    <span class="keyword">bool</span> isMeta = cls-&gt;isMetaClass();</div><div class="line"></div><div class="line">    <span class="comment">// fixme rearrange to remove these intermediate allocations</span></div><div class="line">    method_list_t **mlists = (method_list_t **)</div><div class="line">    malloc(cats-&gt;count * <span class="keyword">sizeof</span>(*mlists));</div><div class="line">    property_list_t **proplists = (property_list_t **)</div><div class="line">    malloc(cats-&gt;count * <span class="keyword">sizeof</span>(*proplists));</div><div class="line">    protocol_list_t **protolists = (protocol_list_t **)</div><div class="line">    malloc(cats-&gt;count * <span class="keyword">sizeof</span>(*protolists));</div><div class="line"></div><div class="line">    <span class="comment">// Count backwards through cats to get newest categories first</span></div><div class="line">    <span class="keyword">int</span> mcount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> propcount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> protocount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i = cats-&gt;count;</div><div class="line">    <span class="keyword">bool</span> fromBundle = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">while</span> (i--) &#123;</div><div class="line">        auto&amp; entry = cats-&gt;list[i];</div><div class="line"></div><div class="line">        method_list_t *mlist = entry.cat-&gt;methodsForMeta(isMeta);</div><div class="line">        <span class="keyword">if</span> (mlist) &#123;</div><div class="line">            mlists[mcount++] = mlist;</div><div class="line">            fromBundle |= entry.hi-&gt;isBundle();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        property_list_t *proplist = entry.cat-&gt;propertiesForMeta(isMeta, entry.hi);</div><div class="line">        <span class="keyword">if</span> (proplist) &#123;</div><div class="line">            proplists[propcount++] = proplist;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        protocol_list_t *protolist = entry.cat-&gt;protocols;</div><div class="line">        <span class="keyword">if</span> (protolist) &#123;</div><div class="line">            protolists[protocount++] = protolist;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    auto rw = cls-&gt;data();</div><div class="line"></div><div class="line">    prepareMethodLists(cls, mlists, mcount, <span class="literal">NO</span>, fromBundle);</div><div class="line">    rw-&gt;methods.attachLists(mlists, mcount);</div><div class="line">    free(mlists);</div><div class="line">    <span class="keyword">if</span> (flush_caches  &amp;&amp;  mcount &gt; <span class="number">0</span>) </div><div class="line">        flushCaches(cls);</div><div class="line"></div><div class="line">    rw-&gt;properties.attachLists(proplists, propcount);</div><div class="line">    free(proplists);</div><div class="line"></div><div class="line">    rw-&gt;protocols.attachLists(protolists, protocount);</div><div class="line">    free(protolists);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>分类方法的列表会被追加到本来的对象方法前面，不是覆盖，是优先调用。可以通过打印所有类的所有方法名来查看：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">2018-05-07</span> <span class="selector-tag">14</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:19.972168+0800</span> <span class="selector-tag">Category</span><span class="selector-attr">[6598:558202]</span> <span class="selector-tag">Person</span> (Test2) <span class="selector-tag">-</span> <span class="selector-tag">run</span></div><div class="line"><span class="selector-tag">2018-05-07</span> <span class="selector-tag">14</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:19.972424+0800</span> <span class="selector-tag">Category</span><span class="selector-attr">[6598:558202]</span> <span class="selector-tag">test</span></div><div class="line"><span class="selector-tag">2018-05-07</span> <span class="selector-tag">14</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:19.972566+0800</span> <span class="selector-tag">Category</span><span class="selector-attr">[6598:558202]</span> <span class="selector-tag">run</span></div><div class="line"><span class="selector-tag">2018-05-07</span> <span class="selector-tag">14</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:19.972681+0800</span> <span class="selector-tag">Category</span><span class="selector-attr">[6598:558202]</span> <span class="selector-tag">run</span></div><div class="line"><span class="selector-tag">2018-05-07</span> <span class="selector-tag">14</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:19.972966+0800</span> <span class="selector-tag">Category</span><span class="selector-attr">[6598:558202]</span> <span class="selector-tag">run</span></div><div class="line"><span class="selector-tag">2018-05-07</span> <span class="selector-tag">14</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:19.973125+0800</span> <span class="selector-tag">Category</span><span class="selector-attr">[6598:558202]</span> <span class="selector-tag">setAge</span>:</div><div class="line"><span class="selector-tag">2018-05-07</span> <span class="selector-tag">14</span><span class="selector-pseudo">:33</span><span class="selector-pseudo">:19.973226+0800</span> <span class="selector-tag">Category</span><span class="selector-attr">[6598:558202]</span> <span class="selector-tag">age</span></div></pre></td></tr></table></figure></p><p>上文代码中主类和两个分类中分别声明了方法<code>- (void)run</code>，打印当前类所有方法名可以发现run出现了三次，所有证明分类只是被添加到主类的方法缓存列表的前面，以便优先调用，不是覆盖，不是覆盖，不是覆盖。</p><p>分类的实现原理是将category中的方法，属性，协议数据放在category_t结构体中，然后结构体内的方法列表拷贝到类对象的方法列表中。</p><h2 id="如果多个分类中同时声明了相同的方法会如何调用"><a href="#如果多个分类中同时声明了相同的方法会如何调用" class="headerlink" title="如果多个分类中同时声明了相同的方法会如何调用"></a>如果多个分类中同时声明了相同的方法会如何调用</h2><p>根据 <code>Xcode -&gt; Build Phases -&gt; Compile Sources</code> 中分类的顺序来决定，下面的分类优先调用。</p><h2 id="Category中load方法"><a href="#Category中load方法" class="headerlink" title="Category中load方法"></a>Category中load方法</h2><p>查看<code>objc_loadmethod.mm</code>源码：</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/***********************************************************************</span></div><div class="line">* call_load_methods</div><div class="line">* Call all pending class and category +load methods.</div><div class="line">* Class +load methods are called superclass-first. </div><div class="line">* Category +load methods are not called until after the parent class's +load.</div><div class="line">* </div><div class="line">* This method must be RE-ENTRANT, because a +load could trigger </div><div class="line">* more image mapping. In addition, the superclass-first ordering </div><div class="line">* must be preserved in the face of re-entrant calls. Therefore, </div><div class="line">* only the OUTERMOST call of this function will do anything, and </div><div class="line">* that call will handle all loadable classes, even those generated </div><div class="line">* while it was running.</div><div class="line">*</div><div class="line">* The sequence below preserves +load ordering in the face of </div><div class="line">* image loading during a +load, and make sure that no </div><div class="line">* +load method is forgotten because it was added during </div><div class="line">* a +load call.</div><div class="line">* Sequence:</div><div class="line">* 1. Repeatedly call class +loads until there aren't any more</div><div class="line">* 2. Call category +loads ONCE.</div><div class="line">* 3. Run more +loads if:</div><div class="line">*    (a) there are more classes to load, OR</div><div class="line">*    (b) there are some potential category +loads that have </div><div class="line">*        still never been attempted.</div><div class="line">* Category +loads are only run once to ensure "parent class first" </div><div class="line">* ordering, even if a category +load triggers a new loadable class </div><div class="line">* and a new loadable category attached to that class. </div><div class="line">*</div><div class="line">* Locking: loadMethodLock must be held by the caller </div><div class="line">*   All other locks must not be held.</div><div class="line">**********************************************************************/</div><div class="line"><span class="keyword">void</span> call_load_methods(<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> loading = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">bool</span> more_categories;</div><div class="line"></div><div class="line">    loadMethodLock.assertLocked();</div><div class="line"></div><div class="line">    <span class="comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span></div><div class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</div><div class="line">    loading = <span class="literal">YES</span>;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> *pool = objc_autoreleasePoolPush();</div><div class="line"></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="comment">// 1. Repeatedly call class +loads until there aren't any more</span></div><div class="line">    <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</div><div class="line">        call_class_loads();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 2. Call category +loads ONCE</span></div><div class="line">    more_categories = call_category_loads();</div><div class="line"></div><div class="line">    <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></div><div class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</div><div class="line"></div><div class="line">    objc_autoreleasePoolPop(pool);</div><div class="line"></div><div class="line">    loading = <span class="literal">NO</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ol><li>优先调用类的load方法之后调用分类的load方法，不过调用类的load方法之前会保证其父类已经调用过load方法。</li><li>多个分类的<code>load</code>方法调用：根据 <code>Xcode -&gt; Build Phases -&gt; Compile Sources</code> 中分类的顺序来决定，下面的分类优先调用。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;iOS底层原理&quot;&gt;&lt;a href=&quot;#iOS底层原理&quot; class=&quot;headerlink&quot; title=&quot;iOS底层原理&quot;&gt;&lt;/a&gt;iOS底层原理&lt;/h1&gt;&lt;h2 id=&quot;预热&quot;&gt;&lt;a href=&quot;#预热&quot; class=&quot;headerlink&quot; title=&quot;预
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Category" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Category/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>socket</title>
    <link href="https://github.com/songMW/stack.github.io/2018/03/05/Objective-C/socket/"/>
    <id>https://github.com/songMW/stack.github.io/2018/03/05/Objective-C/socket/</id>
    <published>2018-03-05T08:01:20.000Z</published>
    <updated>2018-03-05T08:01:20.829Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>StaticLibraryAndFramework</title>
    <link href="https://github.com/songMW/stack.github.io/2018/02/28/Objective-C/StaticLibraryAndFramework/"/>
    <id>https://github.com/songMW/stack.github.io/2018/02/28/Objective-C/StaticLibraryAndFramework/</id>
    <published>2018-02-28T10:32:15.000Z</published>
    <updated>2018-05-09T06:07:17.949Z</updated>
    
    <content type="html"><![CDATA[<h2 id="静态库包含第三方静态库"><a href="#静态库包含第三方静态库" class="headerlink" title="静态库包含第三方静态库"></a>静态库包含第三方静态库</h2><ol><li>制作好自己的静态库；</li><li>将第三方静态库的头文件添加到制作好的静态库中；.a不要添加进来，否则会编译不成功。</li><li>将自己制作好的.a和第三方.a文件同时添加到工程即可。</li><li>如果有资源文件也一并添加到工程中。</li></ol><h2 id="静态库包含第三方动态库"><a href="#静态库包含第三方动态库" class="headerlink" title="静态库包含第三方动态库"></a>静态库包含第三方动态库</h2><ol><li>制作好自己的静态库；</li><li>将第三方动态库添加进来即可。</li></ol><h2 id="动态库包含第三方动态库"><a href="#动态库包含第三方动态库" class="headerlink" title="动态库包含第三方动态库"></a>动态库包含第三方动态库</h2><ol><li>制作好自己的动态库；</li><li>将第三方动态库添加进来即可。</li></ol><h2 id="动态库包含第三方静态库"><a href="#动态库包含第三方静态库" class="headerlink" title="动态库包含第三方静态库"></a>动态库包含第三方静态库</h2><ol><li>制作好自己的动态库；</li><li>将第三方静态库添加进来。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;静态库包含第三方静态库&quot;&gt;&lt;a href=&quot;#静态库包含第三方静态库&quot; class=&quot;headerlink&quot; title=&quot;静态库包含第三方静态库&quot;&gt;&lt;/a&gt;静态库包含第三方静态库&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;制作好自己的静态库；&lt;/li&gt;
&lt;li&gt;将第三方静态库的
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>pod搜索不到解决方法</title>
    <link href="https://github.com/songMW/stack.github.io/2018/01/04/Objective-C/CrashCollection/%E6%90%9C%E7%B4%A2%E4%B8%8D%E5%88%B0%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
    <id>https://github.com/songMW/stack.github.io/2018/01/04/Objective-C/CrashCollection/搜索不到解决方法/</id>
    <published>2018-01-04T09:49:38.000Z</published>
    <updated>2018-05-10T03:38:04.017Z</updated>
    
    <content type="html"><![CDATA[<h2 id="pod搜索不到"><a href="#pod搜索不到" class="headerlink" title="pod搜索不到"></a>pod搜索不到</h2><p>成功发布pod, 使用pod install可以成功添加自己发布的pod到工程,但是却用pod serach 搜索时报错: Unable to find a pod with name, author, summary, or description matching [podname]</p><ol><li><p>执行pod setup<br>终端输入：pod setup<br>会出现Setting up CocoaPods master repo，稍等几十秒，最底下会输出Setup completed。说明执行pod setup成功。</p></li><li><p>如果pod search操作还是搜索失败，如下：<br>终端输入：pod search [podname]<br>输出：Unable to find a pod with name, author, summary, or descriptionmatching [podname] 这时就需要继续下面的步骤了。<br>删除~/Library/Caches/CocoaPods目录下的search_index.json文件<br>pod setup成功后，依然不能pod search，是因为之前你执行pod search生成了search_index.json，此时需要删掉。</p></li><li><p>~/Library/Caches/CocoaPods/ 删除search_index.json再执行pod search<br>终端输入：pod search [podname] (不区分大小写)<br>输出：Creating search index for spec repo ‘master’.. Done!，稍等片刻······就会出现所有带有 [podname] 字段的类库。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;pod搜索不到&quot;&gt;&lt;a href=&quot;#pod搜索不到&quot; class=&quot;headerlink&quot; title=&quot;pod搜索不到&quot;&gt;&lt;/a&gt;pod搜索不到&lt;/h2&gt;&lt;p&gt;成功发布pod, 使用pod install可以成功添加自己发布的pod到工程,但是却用pod se
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="CrashCollection" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/CrashCollection/"/>
    
      <category term="pod搜索不到解决方法" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/CrashCollection/pod%E6%90%9C%E7%B4%A2%E4%B8%8D%E5%88%B0%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>WIFI热点开发</title>
    <link href="https://github.com/songMW/stack.github.io/2017/12/08/Objective-C/WIFI%E7%83%AD%E7%82%B9%E5%BC%80%E5%8F%91/"/>
    <id>https://github.com/songMW/stack.github.io/2017/12/08/Objective-C/WIFI热点开发/</id>
    <published>2017-12-08T10:17:47.000Z</published>
    <updated>2018-05-10T07:22:52.295Z</updated>
    
    <content type="html"><![CDATA[<h2 id="跳转到设置页面"><a href="#跳转到设置页面" class="headerlink" title="跳转到设置页面"></a>跳转到设置页面</h2><p>info.plist 中添加 URL types 并设置 URL Schemes<br>string 类型 prefs<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"prefs:root=WIFI"</span>];</div><div class="line"><span class="keyword">if</span> ([[<span class="built_in">UIApplication</span> sharedApplication] canOpenURL:url])</div><div class="line">&#123;</div><div class="line">    [[<span class="built_in">UIApplication</span> sharedApplication] openURL:url];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2 id="弹出WIFI提示框"><a href="#弹出WIFI提示框" class="headerlink" title="弹出WIFI提示框"></a>弹出WIFI提示框</h2><ol><li>键名：Application uses Wi-Fi 值：YES；</li><li>键名：SBUsesNetwork 值：3；</li><li>iOS9需要向苹果申请授权 <a href="https://developer.apple.com//contact/network-extension" target="_blank" rel="external">苹果授权地址</a>；</li><li>iOS9以下由于受苹果系统限制，不能获取到和设置列表中那样的 WIFI 列表，采用上传当前地理位置从服务器获取开放热点。</li></ol><h2 id="iOS9以下安装描述文件实现："><a href="#iOS9以下安装描述文件实现：" class="headerlink" title="iOS9以下安装描述文件实现："></a>iOS9以下安装描述文件实现：</h2><ol><li>描述文件其实就是 XML 格式的数据；</li><li>下载一个 Apple Configurator2可以自己制作描述文件；</li><li>用文本编辑打开.mobileconfig文件给服务器,他们会按照这个格式来做描述文件；</li><li>需要注意一点是PayloadUUID这个参数是需要客户端上传的,保证应用的唯一性；</li><li><a href="">描述文件签名</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;跳转到设置页面&quot;&gt;&lt;a href=&quot;#跳转到设置页面&quot; class=&quot;headerlink&quot; title=&quot;跳转到设置页面&quot;&gt;&lt;/a&gt;跳转到设置页面&lt;/h2&gt;&lt;p&gt;info.plist 中添加 URL types 并设置 URL Schemes&lt;br&gt;string
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="WIFI热点开发" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/WIFI%E7%83%AD%E7%82%B9%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>URL到页面加载</title>
    <link href="https://github.com/songMW/stack.github.io/2017/11/26/Objective-C/Other/URL%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD/"/>
    <id>https://github.com/songMW/stack.github.io/2017/11/26/Objective-C/Other/URL到页面加载/</id>
    <published>2017-11-26T03:05:05.000Z</published>
    <updated>2018-03-01T07:24:49.898Z</updated>
    
    <content type="html"><![CDATA[<h2 id="引用-stackoverflow-："><a href="#引用-stackoverflow-：" class="headerlink" title="引用 stackoverflow ："></a>引用 <code>stackoverflow</code> ：</h2><p><a href="http://stackoverflow.com/questions/2092527/what-happens-when-you-type-in-a-url-in-browser" target="_blank" rel="external">stackoverflow</a></p><ol><li><p>browser checks cache; if requested object is in cache and is fresh, skip to #9<br>浏览器检查缓存，若缓存中存储着要请求的内容，并且内容是最新的，直接跳转到第9步；</p></li><li><p>browser asks OS for server’s IP address<br>浏览器请求操作系统（OS）解析服务器的IP地址；</p></li><li><p>OS makes a DNS lookup and replies the IP address to the browser<br>操作系统做DNS解析，查找并返回IP地址给浏览器；</p></li><li><p>browser opens a TCP connection to server (this step is much more complex with HTTPS)<br>浏览器与服务器建立TCP连接（若使用的是https协议，连接过程会更加的复杂）；</p></li><li><p>browser sends the HTTP request through TCP connection<br>浏览器通过TCP连接发送http请求；</p></li><li><p>browser receives HTTP response and may close the TCP connection, or reuse it for another request<br>浏览器接收HTTP响应并且可以关闭TCP连接，或者将其重用于另一个请求；</p></li><li><p>browser checks if the response is a redirect (3xx result status codes), authorization request (401), error (4xx and 5xx), etc.; these are handled differently from normal responses (2xx)<br>浏览器检查响应是否是重定向（3xx结果状态代码),授权请求(401),错误（4xx和5xx)等; 这些处理不同于正常响应(2xx）；</p></li><li><p>if cacheable, response is stored in cache<br>如果可高速缓存，则将响应存储在高速缓存中；</p></li><li><p>browser decodes response (e.g. if it’s gzipped)<br>浏览器解码响应（例如，如果是gzip压缩）；</p></li><li><p>browser determines what to do with response (e.g. is it a HTML page, is it an image, is it a sound clip?)<br>浏览器决定如何处理响应（例如，它是一个HTML页面，它是一个图像，它是一个声音剪辑?）；</p></li><li><p>browser renders response, or offers a download dialog for unrecognized types<br>浏览器呈现响应，或为无法识别的类型提供下载对话框。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;引用-stackoverflow-：&quot;&gt;&lt;a href=&quot;#引用-stackoverflow-：&quot; class=&quot;headerlink&quot; title=&quot;引用 stackoverflow ：&quot;&gt;&lt;/a&gt;引用 &lt;code&gt;stackoverflow&lt;/code&gt; ：&lt;
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Other" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/"/>
    
      <category term="URL到页面加载" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/URL%E5%88%B0%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>图片类型</title>
    <link href="https://github.com/songMW/stack.github.io/2017/11/21/Objective-C/Image/ImageType/"/>
    <id>https://github.com/songMW/stack.github.io/2017/11/21/Objective-C/Image/ImageType/</id>
    <published>2017-11-21T04:03:34.000Z</published>
    <updated>2018-05-10T07:21:16.881Z</updated>
    
    <content type="html"><![CDATA[<h2 id="获取扩展名"><a href="#获取扩展名" class="headerlink" title="获取扩展名"></a>获取扩展名</h2><a id="more"></a><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *image = <span class="string">@"xxx.png"</span>;</div><div class="line"><span class="built_in">NSString</span> *extension = image.pathExtension.lowercaseString;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,extension);</div></pre></td></tr></table></figure><p>只适用于可以获取到图片URL的时候</p><h2 id="取出图片数据的第一个字节"><a href="#取出图片数据的第一个字节" class="headerlink" title="取出图片数据的第一个字节"></a>取出图片数据的第一个字节</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *path = [[<span class="built_in">NSBundle</span> mainBundle]pathForResource:<span class="string">@"414x736"</span> ofType:<span class="string">@"png"</span>];</div><div class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfFile:path];</div><div class="line">uint8_t c;</div><div class="line">[data getBytes:&amp;c length: <span class="number">1</span>];</div><div class="line"><span class="keyword">switch</span> (c) &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">0xFF</span>:</div><div class="line">        <span class="keyword">return</span> SDImageFormatJPEG;</div><div class="line">    <span class="keyword">case</span> <span class="number">0x89</span>:</div><div class="line">        <span class="keyword">return</span> SDImageFormatPNG;</div><div class="line">    <span class="keyword">case</span> <span class="number">0x47</span>:</div><div class="line">        <span class="keyword">return</span> SDImageFormatGIF;</div><div class="line">    <span class="keyword">case</span> <span class="number">0x49</span>:</div><div class="line">    <span class="keyword">case</span> <span class="number">0x4D</span>:</div><div class="line">        <span class="keyword">return</span> SDImageFormatTIFF;</div><div class="line">    <span class="keyword">case</span> <span class="number">0x52</span>: &#123;</div><div class="line">        <span class="keyword">if</span> (data.length &gt;= <span class="number">12</span>) &#123;</div><div class="line">            <span class="comment">//RIFF....WEBP</span></div><div class="line">            <span class="built_in">NSString</span> *testString = [[<span class="built_in">NSString</span> alloc] initWithData:[data subdataWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">12</span>)] encoding:<span class="built_in">NSASCIIStringEncoding</span>];</div><div class="line">            <span class="keyword">if</span> ([testString hasPrefix:<span class="string">@"RIFF"</span>] &amp;&amp; [testString hasSuffix:<span class="string">@"WEBP"</span>]) &#123;</div><div class="line">                <span class="keyword">return</span> SDImageFormatWebP;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> <span class="number">0x00</span>: &#123;</div><div class="line">        <span class="keyword">if</span> (data.length &gt;= <span class="number">12</span>) &#123;</div><div class="line">            <span class="comment">//....ftypheic ....ftypheix ....ftyphevc ....ftyphevx</span></div><div class="line">            <span class="built_in">NSString</span> *testString = [[<span class="built_in">NSString</span> alloc] initWithData:[data subdataWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">4</span>, <span class="number">8</span>)] encoding:<span class="built_in">NSASCIIStringEncoding</span>];</div><div class="line">            <span class="keyword">if</span> ([testString isEqualToString:<span class="string">@"ftypheic"</span>] ||</div><div class="line">                [testString isEqualToString:<span class="string">@"ftypheix"</span>] ||</div><div class="line">                [testString isEqualToString:<span class="string">@"ftyphevc"</span>] ||</div><div class="line">                [testString isEqualToString:<span class="string">@"ftyphevx"</span>]) &#123;</div><div class="line">                <span class="keyword">return</span> SDImageFormatHEIC;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><p>类型参考SDWebImage。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;获取扩展名&quot;&gt;&lt;a href=&quot;#获取扩展名&quot; class=&quot;headerlink&quot; title=&quot;获取扩展名&quot;&gt;&lt;/a&gt;获取扩展名&lt;/h2&gt;
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Image" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Image/"/>
    
      <category term="imageType" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Image/imageType/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>ImageI/O</title>
    <link href="https://github.com/songMW/stack.github.io/2017/11/08/Objective-C/Image/ImageI:O/"/>
    <id>https://github.com/songMW/stack.github.io/2017/11/08/Objective-C/Image/ImageI:O/</id>
    <published>2017-11-08T11:24:01.000Z</published>
    <updated>2018-05-10T07:21:21.502Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用Image-I-O-基础"><a href="#使用Image-I-O-基础" class="headerlink" title="使用Image I/O 基础"></a>使用Image I/O 基础</h2><p><code>ImageI/O framework</code>  提供从源图像 <code>CGImageSourceRef</code> 读取数据的不透明的数据类型并且写入图片数据到目的地 <code>CGImageDestinationRef</code>。它支持多种图像格式，包括标准的Web格式、高动态范围的图像和原始的摄像机数据。</p><ul><li>一个URL被认为是 <code>Core Foundation</code> 的数据类型 <code>CFURLRef : A reference to a CFURL object.</code>;</li><li><code>Core Foundation</code> 的对象 <code>CFDataRef</code> 和 <code>CFMutableDataRef</code>;</li><li>data consumer  对象<code>CGDataConsumerRef : An abstraction for data-writing tasks that eliminates the need to manage a raw memory buffer.</code> 和 数据提供对象 <code>CGDataProviderRef:</code> 抽象的数据读取任务，不用管理内存缓存;</li></ul><p>CGDataProviderRef：来自 <code>CFTypeRef</code> 并继承了所有 <code>Core Foundation</code> 的所有共有属性</p><blockquote><p>typedef struct CF_BRIDGED_TYPE(id) CGDataProvider *CGDataProviderRef;</p></blockquote><p>CFTypeRef ：<code>Core Foundation</code> 的基础类型，在多态函数中被用作类型和返回值，是一个通用的对象引用，充当其他<code>Core Foundation</code> 对象的占位符</p><blockquote><p>/<em> Base “type” of all “CF objects”, and polymorphic functions on them </em>/<br>typedef const CF_BRIDGED_TYPE(id) void * CFTypeRef;</p></blockquote><h2 id="工程中使用Image-I-O"><a href="#工程中使用Image-I-O" class="headerlink" title="工程中使用Image I/O"></a>工程中使用Image I/O</h2><blockquote><p> #import <imageio imageio.h=""></imageio></p></blockquote><h2 id="支持的图片类型"><a href="#支持的图片类型" class="headerlink" title="支持的图片类型"></a>支持的图片类型</h2><p><code>ImageI/O framework</code>  支持大多数常见的图片文件格式，比如： JPEG, JPEG2000, RAW, TIFF, BMP, and PNG</p><h3 id="获取最新的I-O支持的图片列表"><a href="#获取最新的I-O支持的图片列表" class="headerlink" title="获取最新的I/O支持的图片列表"></a>获取最新的I/O支持的图片列表</h3><ul><li><code>CGImageSourceCopyTypeIdentifiers</code> 返回一个 <code>UTIs</code> 数组是 <code>ImageI/O</code> 支持的图片来源</li><li><code>CGImageDestinationCopyTypeIdentifiers</code>  返回一个 <code>UTIs</code> 数组是 <code>ImageI/O</code> 支持的图片目标</li></ul><p>Getting and printing supported UTIs：<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CFArrayRef mySourceTypes = CGImageSourceCopyTypeIdentifiers()<span class="comment">;</span></div><div class="line">CFShow(<span class="name">mySourceTypes</span>)<span class="comment">;</span></div><div class="line">CFArrayRef myDestinationTypes = CGImageDestinationCopyTypeIdentifiers()<span class="comment">;</span></div><div class="line">CFShow(<span class="name">myDestinationTypes</span>)<span class="comment">;</span></div></pre></td></tr></table></figure></p><p>UTLs 和 图片内容类型常量</p><table><thead><tr><th>Uniform type identifier</th><th style="text-align:right">Image content type constant</th></tr></thead><tbody><tr><td>public.image</td><td style="text-align:right">kUTTypeImage</td></tr><tr><td>public.png</td><td style="text-align:right">kUTTypePNG</td></tr><tr><td>public.jpeg</td><td style="text-align:right">kUTTypeJPEG</td></tr><tr><td>public.jpeg-2000 (OS X only)</td><td style="text-align:right">kUTTypeJPEG2000</td></tr><tr><td>public.tiff</td><td style="text-align:right">kUTTypeTIFF</td></tr><tr><td>com.apple.pict (OS X only)</td><td style="text-align:right">kUTTypePICT</td></tr><tr><td>com.compuserve.gif</td><td style="text-align:right">kUTTypeGIF</td></tr></tbody></table><h2 id="实现图片渐进式"><a href="#实现图片渐进式" class="headerlink" title="实现图片渐进式"></a>实现图片渐进式</h2><p>总结步骤：</p><ol><li>获取图片 NSData 数据；</li><li>调用 <code>CGImageSourceCreateIncremental</code> 方法创建增量图片源；</li><li>根据获取到的 NSData 创建 CFData 对象；</li><li>调用 <code>CGImageSourceUpdateData</code>  来更新图片。<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.data = [<span class="built_in">NSMutableData</span> data];</div><div class="line">    _loadFinished = <span class="literal">NO</span>;</div><div class="line">    _dataLength = <span class="number">0</span>;</div><div class="line"></div><div class="line">    _sourceRef = <span class="built_in">CGImageSourceCreateIncremental</span>(<span class="literal">NULL</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)loadImageWithUrl</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:imageURL];</div><div class="line">    <span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration] delegate:<span class="keyword">self</span> delegateQueue:[[<span class="built_in">NSOperationQueue</span> alloc]init]];</div><div class="line">    <span class="built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithURL:url];</div><div class="line">    [task resume];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask didReceiveData:(<span class="built_in">NSData</span> *)data</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span>.data appendData:data];</div><div class="line">    _loadFinished = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">if</span> (_dataLength == dataTask.response.expectedContentLength) &#123;</div><div class="line">        _loadFinished = <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    _dataLength = dataTask.countOfBytesReceived;</div><div class="line">    [<span class="keyword">self</span> showImage:<span class="keyword">self</span>.data];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)showImage:(<span class="built_in">NSData</span> *)data</div><div class="line">&#123;</div><div class="line">    <span class="built_in">CFDataRef</span> dataRef = (__bridge <span class="built_in">CFDataRef</span>)data;</div><div class="line">    <span class="built_in">CGImageSourceUpdateData</span>(_sourceRef, dataRef, _loadFinished);</div><div class="line">    <span class="built_in">CGImageRef</span> imageRef = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(_sourceRef, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">        <span class="keyword">self</span>.showImageView.image = [<span class="built_in">UIImage</span> imageWithCGImage:imageRef];</div><div class="line">        <span class="built_in">CGImageRelease</span>(imageRef);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ol><p>到此应该就可以看到效果。<br>注意点：</p><ul><li>使用<code>CGImageSourceCreateImageAtIndex</code> 创建  <code>CGImageRef</code> 对象，需要手动释放，否则内存会骤增；</li><li>需要在主线程中更新UI。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;使用Image-I-O-基础&quot;&gt;&lt;a href=&quot;#使用Image-I-O-基础&quot; class=&quot;headerlink&quot; title=&quot;使用Image I/O 基础&quot;&gt;&lt;/a&gt;使用Image I/O 基础&lt;/h2&gt;&lt;p&gt;&lt;code&gt;ImageI/O framewo
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Image" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Image/"/>
    
      <category term="ImageI/O" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Image/ImageI-O/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>google人机验证</title>
    <link href="https://github.com/songMW/stack.github.io/2017/10/10/Objective-C/Other/google%E4%BA%BA%E6%9C%BA%E9%AA%8C%E8%AF%81/"/>
    <id>https://github.com/songMW/stack.github.io/2017/10/10/Objective-C/Other/google人机验证/</id>
    <published>2017-10-10T02:22:00.000Z</published>
    <updated>2018-03-01T07:24:33.791Z</updated>
    
    <content type="html"><![CDATA[<p>使用翻墙工具时有时会弹出人机验证的界面，很是麻烦，网上搜到一个解决方法总结如下：</p><blockquote><p>在谷歌浏览器地址栏输入recaptcha回车<br>跳到人机身份验证页面，打上√，确定就行了！<br>以后再出现人机验证只需打个勾就行了！</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;使用翻墙工具时有时会弹出人机验证的界面，很是麻烦，网上搜到一个解决方法总结如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在谷歌浏览器地址栏输入recaptcha回车&lt;br&gt;跳到人机身份验证页面，打上√，确定就行了！&lt;br&gt;以后再出现人机验证只需打个勾就行了！&lt;/p&gt;
&lt;/
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Other" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/"/>
    
      <category term="google人机验证" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/google%E4%BA%BA%E6%9C%BA%E9%AA%8C%E8%AF%81/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>ImageI/O编解码</title>
    <link href="https://github.com/songMW/stack.github.io/2017/10/09/Objective-C/Image/ImageI-O%E7%BC%96%E8%A7%A3%E7%A0%81/"/>
    <id>https://github.com/songMW/stack.github.io/2017/10/09/Objective-C/Image/ImageI-O编解码/</id>
    <published>2017-10-09T10:56:07.000Z</published>
    <updated>2018-05-10T07:21:56.179Z</updated>
    
    <content type="html"><![CDATA[<h1 id="解码"><a href="#解码" class="headerlink" title="解码"></a>解码</h1><p>将已经编码后的图像数据格式转化为可以被渲染的数据。<br>Image/IO的解码，支持了常见的图像格式，包括PNG、APNG、JPEG、GIF、BMP、TIFF <code>CGImageSourceCopyTypeIdentifiers</code> 可以获取支持的图像格式。<br>在iOS 11之后支持了HEIC（即使用了HEVC编码的HEIF格式）。</p><h2 id="静态图"><a href="#静态图" class="headerlink" title="静态图"></a>静态图</h2><p>静态图的解码步骤：</p><ol><li>创建CGImageSource；</li><li>读取图像格式元数据；</li><li>解码得到CGImage；</li><li>生成上层的UIImage，清理。<br>创建CGImageSource<br>CGImageSouce，表示的是一个待解码数据的输入。</li></ol><ul><li>CGImageSourceCreateWithData： 二进制数据（CGData）中创建ImageSource；</li><li>CGImageSourceCreateWithURL： 指定一个URL创建ImageSource；</li><li>CGImageSourceCreateWithDataProvider：从DataProvide中创建ImageSource，DataProvider提供了很多种输入，包括内存，文件，网络，流等。<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *path = [[<span class="built_in">NSBundle</span> mainBundle]pathForResource:<span class="string">@"14444473,2560,1600"</span> ofType:<span class="string">@"jpg"</span>];</div><div class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfFile:path];</div><div class="line"></div><div class="line"><span class="built_in">CFDataRef</span> dataRef = (__bridge <span class="built_in">CFDataRef</span>)data;</div><div class="line"><span class="comment">// 创建CGImageSource</span></div><div class="line"><span class="built_in">CGImageSourceRef</span> sourceRef = <span class="built_in">CGImageSourceCreateWithData</span>(dataRef, <span class="literal">NULL</span>);</div><div class="line"><span class="built_in">NSAssert</span>(sourceRef != <span class="literal">nil</span>, <span class="string">@"sourceRef is nil"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 读取图像格式元数据</span></div><div class="line"><span class="built_in">NSDictionary</span> *imageProperties = (__bridge <span class="built_in">NSDictionary</span> *)<span class="built_in">CGImageSourceCopyPropertiesAtIndex</span>(sourceRef, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"获取属性列表：%@"</span>, imageProperties);</div><div class="line"><span class="built_in">NSUInteger</span> width = [imageProperties[(__bridge <span class="built_in">NSString</span> *)kCGImagePropertyPixelWidth] unsignedIntegerValue];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"图片宽：%@"</span>, @(width));</div><div class="line"><span class="built_in">NSUInteger</span> height = [imageProperties[(__bridge <span class="built_in">NSString</span> *)kCGImagePropertyPixelHeight] unsignedIntegerValue];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"图片高：%@"</span>, @(height));</div><div class="line"><span class="built_in">BOOL</span> hasAlpha = [imageProperties[(__bridge <span class="built_in">NSString</span> *)kCGImagePropertyHasAlpha] boolValue];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"是否含有Alpha通道：%@"</span>, @(hasAlpha));</div><div class="line"><span class="comment">//图像格式：CGImageSourceGetType</span></div><div class="line"><span class="built_in">CFStringRef</span> stringRef = <span class="built_in">CGImageSourceGetType</span>(sourceRef);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"图像格式：%@"</span>, (__bridge <span class="built_in">NSString</span> *)stringRef);</div><div class="line"><span class="comment">//图像数量（动图）：CGImageSourceGetCount</span></div><div class="line">size_t t = <span class="built_in">CGImageSourceGetCount</span>(sourceRef);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"图像数量：%zu"</span>, t);</div><div class="line"></div><div class="line"><span class="comment">// 解码得到CGImage</span></div><div class="line"><span class="built_in">CGImageRef</span> imageRef = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(sourceRef, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line"><span class="comment">// 生成UIImage</span></div><div class="line"><span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithCGImage:imageRef];</div><div class="line"><span class="keyword">self</span>.showImageView.image = image;</div><div class="line"><span class="built_in">CGImageRelease</span>(imageRef);</div><div class="line"><span class="built_in">CFRelease</span>(sourceRef);</div></pre></td></tr></table></figure></li></ul><p>注意点：</p><ol><li><code>CGImageSourceCreateImageAtIndex</code> 对于静态图 index 传0；</li><li><code>CGImageSourceCopyPropertiesAtIndex</code>  获取图片的元信息</li><li>释放</li></ol><h2 id="动态图"><a href="#动态图" class="headerlink" title="动态图"></a>动态图</h2><ol><li>创建CGImageSource ；</li><li>使用<code>CGImageSourceGetCount</code>获取到图片的帧数；</li><li>循环遍历每一帧，循环静态图2～4步骤<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:dynamicImageURL];</div><div class="line"><span class="built_in">CGImageSourceRef</span> sourcesRef = <span class="built_in">CGImageSourceCreateWithURL</span>((__bridge_retained <span class="built_in">CFURLRef</span>)url, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line"><span class="comment">// 获取图片帧数</span></div><div class="line">size_t count = <span class="built_in">CGImageSourceGetCount</span>(sourcesRef);</div><div class="line"><span class="built_in">NSMutableArray</span>&lt;<span class="built_in">UIImage</span> *&gt; *images = [<span class="built_in">NSMutableArray</span> array];</div><div class="line"><span class="keyword">double</span> totalDuration = <span class="number">0</span>;</div><div class="line"><span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line"><span class="built_in">NSDictionary</span> *propertiesDict = (__bridge_transfer <span class="built_in">NSDictionary</span> *)<span class="built_in">CGImageSourceCopyPropertiesAtIndex</span>(sourcesRef, i, <span class="literal">NULL</span>);</div><div class="line"><span class="built_in">NSDictionary</span> *gitPropertiesDict = propertiesDict[(<span class="built_in">NSString</span> *)kCGImagePropertyGIFDictionary];</div><div class="line"><span class="keyword">double</span> duration = [gitPropertiesDict[(<span class="built_in">NSString</span> *)kCGImagePropertyGIFUnclampedDelayTime] doubleValue]; <span class="comment">// GIF原始的帧持续时长，秒数</span></div><div class="line">totalDuration += duration;</div><div class="line"><span class="built_in">CGImageRef</span> imageRef = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(sourcesRef, i, <span class="literal">NULL</span>);</div><div class="line"><span class="built_in">UIImage</span> *image  = [<span class="built_in">UIImage</span> imageWithCGImage:imageRef];</div><div class="line">[images addObject:image];</div><div class="line"><span class="built_in">CGImageRelease</span>(imageRef);</div><div class="line">&#125;</div><div class="line"><span class="keyword">self</span>.showImageView.image = [<span class="built_in">UIImage</span> animatedImageWithImages:images duration:totalDuration];</div></pre></td></tr></table></figure></li></ol><p>UIImage这个animatedImages的接口，会根据传入的images的数量，平均分配传入的totalDuration的展示时长</p><h1 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h1><p>指的就是将一个UIImage表示的图像，编码为对应图像格式的数据，输出NSData的过程。Image/IO提供的对应概念，叫做CGImageDestination，表示一个输出。之后的编码相关的操作与Destination对应。</p><h2 id="静态图-1"><a href="#静态图-1" class="headerlink" title="静态图"></a>静态图</h2><p>静态图编码步骤：</p><ol><li>创建CGImageDestination；</li><li>添加图像格式元数据（可选）和CGImage；</li><li>编码得到NSData。</li></ol><p>创建 CGImageDestination：</p><ol><li><code>CGImageDestinationCreateWithURL</code></li><li><code>CGImageDestinationCreateWithData</code></li><li><code>CGImageDestinationCreateWithDataConsumer</code></li></ol><p>添加图片到CGImageDestination</p><ol><li><code>CGImageDestinationAddImage</code></li><li><code>CGImageDestinationAddImageFromSource</code></li></ol><p>验证是否添加完成<br>使用<code>CGImageDestinationFinalize</code>验证图片是否添加完成，一旦完成后就不能向图片添加更多的数据。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure><h2 id="动态图-1"><a href="#动态图-1" class="headerlink" title="动态图"></a>动态图</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;解码&quot;&gt;&lt;a href=&quot;#解码&quot; class=&quot;headerlink&quot; title=&quot;解码&quot;&gt;&lt;/a&gt;解码&lt;/h1&gt;&lt;p&gt;将已经编码后的图像数据格式转化为可以被渲染的数据。&lt;br&gt;Image/IO的解码，支持了常见的图像格式，包括PNG、APNG、JPEG、GI
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Image" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Image/"/>
    
      <category term="ImageI/O编解码" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Image/ImageI-O%E7%BC%96%E8%A7%A3%E7%A0%81/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>图片压缩</title>
    <link href="https://github.com/songMW/stack.github.io/2017/10/02/Objective-C/Image/%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9/"/>
    <id>https://github.com/songMW/stack.github.io/2017/10/02/Objective-C/Image/图片压缩/</id>
    <published>2017-10-02T08:31:06.000Z</published>
    <updated>2018-03-01T07:19:40.162Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PNG-和-JPEG（JPG）区别"><a href="#PNG-和-JPEG（JPG）区别" class="headerlink" title="PNG 和 JPEG（JPG）区别"></a>PNG 和 JPEG（JPG）区别</h2><ol><li>PNG 图片是无损压缩，并且支持 alpha 通道，</li><li>JPEG 图片是有损压缩，可以指定 0-100% 的压缩比；</li><li>苹果提供了两个函数用来生成 PNG 和 JPEG 图片：</li></ol><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// <span class="built_in">return</span> <span class="built_in">image</span> as PNG. May <span class="built_in">return</span> nil <span class="keyword">if</span> <span class="built_in">image</span> has no CGImageRef <span class="keyword">or</span> invalid bitmap format</div><div class="line">UIKIT_EXTERN NSData * __nullable UIImagePNGRepresentation(UIImage * __nonnull <span class="built_in">image</span>);</div><div class="line"></div><div class="line">// <span class="built_in">return</span> <span class="built_in">image</span> as JPEG. May <span class="built_in">return</span> nil <span class="keyword">if</span> <span class="built_in">image</span> has no CGImageRef <span class="keyword">or</span> invalid bitmap format. compression <span class="built_in">is</span> <span class="number">0</span>(most)..<span class="number">1</span>(least)</div><div class="line">UIKIT_EXTERN NSData * __nullable UIImageJPEGRepresentation(UIImage * __nonnull <span class="built_in">image</span>, CGFloat compressionQuality);</div></pre></td></tr></table></figure><h2 id="图片为什么需要解压图片"><a href="#图片为什么需要解压图片" class="headerlink" title="图片为什么需要解压图片"></a>图片为什么需要解压图片</h2><p>图片的解压缩需要消耗大量的 CPU 时间，为什么需要将图片解压后才能展示到屏幕上呢？这里引入一个概念<a href="https://developer.apple.com/library/content/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_images/dq_images.html#//apple_ref/doc/uid/TP30001066-CH212-SW3" target="_blank" rel="external">位图</a></p><blockquote><p>A bitmap image (or sampled image) is an array of pixels (or samples). Each pixel represents a single point in the image. JPEG, TIFF, and PNG graphics files are examples of bitmap images.<br> 位图就是一个数组，数组中每个元素代表图片中的一个点。</p></blockquote><h3 id="获取图片的原始数据"><a href="#获取图片的原始数据" class="headerlink" title="获取图片的原始数据"></a>获取图片的原始数据</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CFDataRef ref = CGDataProviderCopyData(<span class="name">CGImageGetDataProvider</span>(<span class="name">_image</span>.CGImage))<span class="comment">;</span></div></pre></td></tr></table></figure><h3 id="计算图片所占内存"><a href="#计算图片所占内存" class="headerlink" title="计算图片所占内存"></a>计算图片所占内存</h3><h4 id="方式一："><a href="#方式一：" class="headerlink" title="方式一："></a>方式一：</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">_image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"320x480"</span>];</div><div class="line"><span class="built_in">CGFloat</span> cgImageBytesPerRow = <span class="built_in">CGImageGetBytesPerRow</span>(_image.CGImage); <span class="comment">// 2560</span></div><div class="line"><span class="built_in">CGFloat</span> cgImageHeight = <span class="built_in">CGImageGetHeight</span>(_image.CGImage); <span class="comment">// 960</span></div><div class="line"><span class="built_in">NSUInteger</span> size  = cgImageHeight * cgImageBytesPerRow;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"size:%lu"</span>,(<span class="keyword">unsigned</span> <span class="keyword">long</span>)size); <span class="comment">// 输出 2457600 bytes</span></div></pre></td></tr></table></figure><h4 id="方式二："><a href="#方式二：" class="headerlink" title="方式二："></a>方式二：</h4><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CFDataRef ref = CGDataProviderCopyData(<span class="name">CGImageGetDataProvider</span>(<span class="name">_image</span>.CGImage))<span class="comment">;</span></div><div class="line">NSLog(@<span class="string">"%@"</span>, ref)<span class="comment">; // 输出 2457600 bytes</span></div></pre></td></tr></table></figure><p>打印可以看出一张320*480的图片加载并成功展示到页面所占用的内存达到 2457600 / 1024 / 1024 大约有2.34375M。如果有很多张这样的图片，内存完全不够用。</p><p>这里位图和二进制不是一个概念。</p><h2 id="图片压缩"><a href="#图片压缩" class="headerlink" title="图片压缩"></a>图片压缩</h2><h3 id="等比压缩-常用"><a href="#等比压缩-常用" class="headerlink" title="等比压缩 常用"></a>等比压缩 常用</h3><p>使用场景：后台返回固定图片尺寸用于支持iOS和android，比如返回1920x1080大小的图片，如不压缩在iPhone的所有尺寸展示：</p><ol><li>全屏展示：图片展示不全；</li><li>指定其他大小尺寸展示：图片会失真</li></ol><p>此时需要按照等比压缩的方式来压缩图片：假定后台服务器返回图片的尺寸是固定的。<br>在程序中写定图片的宽和高：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> image_width 1080</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> image_height 1920</span></div></pre></td></tr></table></figure></p><p>按需求来设定图片展示大小，假设想要在width * height 大小的地方展示图片，如何计算压缩后图片的大小？</p><ol><li><p>定宽<br>图片宽：width<br>图片高：width * image_height / image_width</p></li><li><p>定高<br>图片宽：height * image_width / image_height<br>图片高：height<br>计算完成后在根据压缩后图片的大小来调整展示view的大小。<br>如果服务器返回的图片尺寸不是固定的也可以进行压缩，只是每次计算之前先要获取到图片，拿到图片的大小，过程一样。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PNG-和-JPEG（JPG）区别&quot;&gt;&lt;a href=&quot;#PNG-和-JPEG（JPG）区别&quot; class=&quot;headerlink&quot; title=&quot;PNG 和 JPEG（JPG）区别&quot;&gt;&lt;/a&gt;PNG 和 JPEG（JPG）区别&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;PNG 
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="KnowledgeLists" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/KnowledgeLists/"/>
    
      <category term="Image" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/KnowledgeLists/Image/"/>
    
      <category term="图片压缩" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/KnowledgeLists/Image/%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>屏蔽浏览器广告</title>
    <link href="https://github.com/songMW/stack.github.io/2017/09/28/Objective-C/Other/%E5%B1%8F%E8%94%BD%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B9%BF%E5%91%8A/"/>
    <id>https://github.com/songMW/stack.github.io/2017/09/28/Objective-C/Other/屏蔽浏览器广告/</id>
    <published>2017-09-28T10:27:10.000Z</published>
    <updated>2018-03-01T07:24:13.941Z</updated>
    
    <content type="html"><![CDATA[<ol><li><p>AdBlock Plus 屏蔽广告插件；</p></li><li><p>清除百度推广 www.baidu.com 底部”使用百度前必读”—&gt;隐私权保护声明–&gt;个性化配置–&gt;选择停用。</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;&lt;p&gt;AdBlock Plus 屏蔽广告插件；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;清除百度推广 www.baidu.com 底部”使用百度前必读”—&amp;gt;隐私权保护声明–&amp;gt;个性化配置–&amp;gt;选择停用。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;

      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Other" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/"/>
    
      <category term="屏蔽浏览器广告" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/%E5%B1%8F%E8%94%BD%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B9%BF%E5%91%8A/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>堆和栈</title>
    <link href="https://github.com/songMW/stack.github.io/2017/09/15/Objective-C/Other/%E5%A0%86%E5%92%8C%E6%A0%88/"/>
    <id>https://github.com/songMW/stack.github.io/2017/09/15/Objective-C/Other/堆和栈/</id>
    <published>2017-09-15T10:09:25.000Z</published>
    <updated>2018-03-01T07:23:57.394Z</updated>
    
    <content type="html"><![CDATA[<h2 id="栈和堆存储在哪"><a href="#栈和堆存储在哪" class="headerlink" title="栈和堆存储在哪?"></a>栈和堆存储在哪?</h2><p>他们都存储在电脑的 RAM(Random Access Memory) 中</p><h2 id="栈和堆中都保存的是什么"><a href="#栈和堆中都保存的是什么" class="headerlink" title="栈和堆中都保存的是什么?"></a>栈和堆中都保存的是什么?</h2><ol><li>栈 —&gt;编译器在需要的时候分配，在不需要的时候自动清除变量的存储区，通常是局部变量，函数参数等；</li><li>堆 —&gt;由 new 分配的操作块，一个 new 对应一个 delete</li><li>自由存储区 —&gt;由 malloc 分配的内存块</li><li>全局/静态存储区 —&gt;全局变量和静态变量被分配到同一块内存中</li><li>常量存储区 —&gt;这时一块比较特殊的存储区，存放常量，不能修改<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> *p = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">5</span>]；</div><div class="line">&#125;</div></pre></td></tr></table></figure></li></ol><p>看到 new 说明分配了一块堆内存，那么指针 p 是什么? p 分配的是一块栈内存，这句意思是在栈内存中存放一个指向一块堆内容的指针 p。程序先会确定在堆中分配内存的大小，然后调用 operator new 分配内存，让后返回这块内存的首地址，放入栈中。</p><h2 id="栈和堆区别是什么"><a href="#栈和堆区别是什么" class="headerlink" title="栈和堆区别是什么?"></a>栈和堆区别是什么?</h2><ol><li>管理方式不同：对于栈来说，是由编译器自动管理，无需我们手动控制；对于堆来说，释放工作由程序员控制，容易产生 memory leak；</li><li>空间大小不同:栈空间大小是1M，而在32位系统下，堆内存空间可以达到4G；</li><li>产生碎片不同:对于堆来说，频繁的 new/delete 势必会造成内存空间的不连续，而从造成大量碎片，使程序效率降低；对栈来说，不会产生碎片问题，栈是先进后出的队列不可能有一个内存块从栈中间弹出，在他弹出之前，在他上面的栈内容已经弹出；</li><li>生长方式不同:对于堆来说，生长方向是向上的，也就是向着内存地址增加的方向；对于栈来说，它的生长方向是向下的，是向着内存地址减少的方向增长；</li><li>分配方式不同:堆是动态分配，没有静态分配的堆；栈有2中分配方式:静态分配和动态分配，静态分配是编译器完成的，比如局部变量的分配；动态分配由 alloc 函数进行分配，由编译器进行释放；</li><li>分配效率不同:栈是机器系统提供的数据结构，计算机会在底层对栈提供支持:分配专门的寄存器存放栈地址，压栈出栈都有专门的指令执行，这就决定栈的效率比较高；堆是 C/C++函数提供的，例如分配一块内存，库函数会按照一定的算法在堆内存中搜索可用的足够大小的空间，如果没有足够大小的空间(可能由于内存碎片太多)，就有可能调用系统功能去增加程序数据段的内存空间，这样就有机会分到足够大小的内存，然后进行返回。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;栈和堆存储在哪&quot;&gt;&lt;a href=&quot;#栈和堆存储在哪&quot; class=&quot;headerlink&quot; title=&quot;栈和堆存储在哪?&quot;&gt;&lt;/a&gt;栈和堆存储在哪?&lt;/h2&gt;&lt;p&gt;他们都存储在电脑的 RAM(Random Access Memory) 中&lt;/p&gt;
&lt;h2 id
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Other" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/"/>
    
      <category term="堆和栈" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/%E5%A0%86%E5%92%8C%E6%A0%88/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>MPMoviePlayerViewController</title>
    <link href="https://github.com/songMW/stack.github.io/2017/08/22/Objective-C/AVFoundation/MoviePlayer/MPMoviePlayerViewController/"/>
    <id>https://github.com/songMW/stack.github.io/2017/08/22/Objective-C/AVFoundation/MoviePlayer/MPMoviePlayerViewController/</id>
    <published>2017-08-22T12:34:53.000Z</published>
    <updated>2018-05-10T07:20:56.399Z</updated>
    
    <content type="html"><![CDATA[<p>首先贴上<a href="https://developer.apple.com/documentation/mediaplayer/mpmovieplayercontroller" target="_blank" rel="external">官方文档</a></p><p>先看下头文件:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">MPMoviePlayerViewController </span>: UIViewController</div><div class="line"></div><div class="line">- (instancetype)<span class="attribute">initWithContentURL</span>:(NSURL *)contentURL NS_DESIGNATED_INITIALIZER;</div><div class="line"></div><div class="line"><span class="variable">@property</span> (nonatomic, readonly) MPMoviePlayerController *moviePlayer;</div><div class="line"></div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@interface</span> UIViewController (MPMoviePlayerViewController)</div><div class="line"></div><div class="line">- (void)<span class="attribute">presentMoviePlayerViewControllerAnimated</span>:(MPMoviePlayerViewController *)moviePlayerViewController;</div><div class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">dismissMoviePlayerViewControllerAnimated</span>;</div><div class="line"></div><div class="line">@<span class="selector-tag">end</span></div></pre></td></tr></table></figure></p><ul><li>MPMoviePlayerViewController 继承 UIViewController;</li><li>API很少, 主要是 moviePlayer 这个属性, 是对 MPMoviePlayerController 的一层封装;</li><li>当然也拥有 MPMoviePlayerController 的所有功能;</li><li>使用简单, 点击Done按钮会自动退出, 有进度条, 快进, 快退, 播放按钮.</li><li>可以去自定义添加控件到播放页面, 不建议这么做, 可以直接使用 MPMoviePlayerController</li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MPMoviePlayerViewController *mpMovieController = <span class="string">[[MPMoviePlayerViewController alloc]initWithContentURL:[NSURL fileURLWithPath:videoPath]]</span>;</div><div class="line">[vc presentViewController:mpMovieController animated:YES completion:<span class="literal">nil</span>];</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;首先贴上&lt;a href=&quot;https://developer.apple.com/documentation/mediaplayer/mpmovieplayercontroller&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="AVFoundation" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/AVFoundation/"/>
    
      <category term="MoviePlayer" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/AVFoundation/MoviePlayer/"/>
    
      <category term="MPMoviePlayerViewController" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/AVFoundation/MoviePlayer/MPMoviePlayerViewController/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>DS_Store</title>
    <link href="https://github.com/songMW/stack.github.io/2017/08/16/Objective-C/Other/DS-Store/"/>
    <id>https://github.com/songMW/stack.github.io/2017/08/16/Objective-C/Other/DS-Store/</id>
    <published>2017-08-16T09:43:06.000Z</published>
    <updated>2018-03-01T07:24:22.788Z</updated>
    
    <content type="html"><![CDATA[<h2 id="DS-Store-是用来存储这个文件夹的显示属性的：比如文件图标的摆放位置。删除以后的副作用就是这些信息的失去"><a href="#DS-Store-是用来存储这个文件夹的显示属性的：比如文件图标的摆放位置。删除以后的副作用就是这些信息的失去" class="headerlink" title=".DS_Store 是用来存储这个文件夹的显示属性的：比如文件图标的摆放位置。删除以后的副作用就是这些信息的失去."></a>.DS_Store 是用来存储这个文件夹的显示属性的：比如文件图标的摆放位置。删除以后的副作用就是这些信息的失去.</h2><ul><li>Mac 下隐藏显示.DS_Store 方法:<br>显示Mac隐藏文件的命令：defaults write com.apple.finder AppleShowAllFiles -bool true</li><li>显示Mac隐藏文件的命令：defaults write com.apple.finder AppleShowAllFiles YES</li><li>隐藏Mac隐藏文件的命令：defaults write com.apple.finder AppleShowAllFiles -bool false</li><li>隐藏Mac隐藏文件的命令：defaults write com.apple.finder AppleShowAllFiles NO</li><li>重启Finder：鼠标单击窗口左上角的苹果标志–&gt;强制退出–&gt;Finder–&gt;重新启动</li></ul><h2 id="设置忽略-DS-Store"><a href="#设置忽略-DS-Store" class="headerlink" title="设置忽略.DS_Store"></a>设置忽略.DS_Store</h2><ul><li>进入:/Users/xx/.subversion打开 config</li><li>搜索global-ignores 找到global-ignores = <em>.o </em>.lo <em>.la </em>.al .libs <em>.so </em>.so.[0-9]<em> </em>.a <em>.pyc </em>.pyo <em>.rej </em>~ #<em># .#</em> .*.swp .DS_Store  取消注解.</li></ul><h2 id="设置忽略-xcuserstate-确保global-ignores已经取消注解"><a href="#设置忽略-xcuserstate-确保global-ignores已经取消注解" class="headerlink" title="设置忽略.xcuserstate 确保global-ignores已经取消注解"></a>设置忽略.xcuserstate 确保global-ignores已经取消注解</h2><ul><li>进入:/Users/xx/.subversion打开 config</li><li>搜索enable-auto-props 取消注释</li><li>搜索[auto-props]在下面添加:<br><em>.mode</em>=svn:mime-type=text/X-xcode<br><em>.pbxuser=svn:mime-type=text/X-xcode</em>.perspective<em>=svn:mime-type=text/X-xcode</em>.pbxproj=svn:mime-type=text/X-xcode</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;DS-Store-是用来存储这个文件夹的显示属性的：比如文件图标的摆放位置。删除以后的副作用就是这些信息的失去&quot;&gt;&lt;a href=&quot;#DS-Store-是用来存储这个文件夹的显示属性的：比如文件图标的摆放位置。删除以后的副作用就是这些信息的失去&quot; class=&quot;h
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Other" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/"/>
    
      <category term="DS_Store" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/DS-Store/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>XcodeCommand</title>
    <link href="https://github.com/songMW/stack.github.io/2017/08/15/Objective-C/Other/XcodeCommand/"/>
    <id>https://github.com/songMW/stack.github.io/2017/08/15/Objective-C/Other/XcodeCommand/</id>
    <published>2017-08-15T10:09:25.000Z</published>
    <updated>2018-02-05T07:31:19.188Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PROJECT-DIR"><a href="#PROJECT-DIR" class="headerlink" title="${PROJECT_DIR}"></a>${PROJECT_DIR}</h2><blockquote><p>${PROJECT_DIR} = /path/AppName<br>/path ：当前工程所在路径<br>AppName：打开Xcode工程后显示的工程名称</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PROJECT-DIR&quot;&gt;&lt;a href=&quot;#PROJECT-DIR&quot; class=&quot;headerlink&quot; title=&quot;${PROJECT_DIR}&quot;&gt;&lt;/a&gt;${PROJECT_DIR}&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;${PROJECT_DIR} 
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="Other" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/"/>
    
      <category term="XcodeCommand" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/Other/XcodeCommand/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>MPMoviePlayerController</title>
    <link href="https://github.com/songMW/stack.github.io/2017/07/30/Objective-C/AVFoundation/MoviePlayer/MPMoviePlayerController/"/>
    <id>https://github.com/songMW/stack.github.io/2017/07/30/Objective-C/AVFoundation/MoviePlayer/MPMoviePlayerController/</id>
    <published>2017-07-30T03:38:30.000Z</published>
    <updated>2018-05-10T07:21:03.692Z</updated>
    
    <content type="html"><![CDATA[<p>首先贴上<a href="https://developer.apple.com/documentation/mediaplayer/mpmovieplayercontroller" target="_blank" rel="external">官方文档</a></p><h2 id="1-初始化"><a href="#1-初始化" class="headerlink" title="1. 初始化"></a>1. 初始化</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line"></div><div class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.moviePlayerController.view];</div><div class="line">    [<span class="keyword">self</span>.moviePlayerController.view makeConstraints:^(MASConstraintMaker *make) &#123;</div><div class="line">        make.top.left.bottom.right.equalTo(<span class="keyword">self</span>.view);</div><div class="line">    &#125;];</div><div class="line">    [<span class="keyword">self</span>.moviePlayerController prepareToPlay];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">MPMoviePlayerController</span> *)moviePlayerController</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!_moviePlayerController) &#123;</div><div class="line">        _moviePlayerController = [[<span class="built_in">MPMoviePlayerController</span> alloc]init];</div><div class="line">        _moviePlayerController.fullscreen = <span class="literal">NO</span>;</div><div class="line">        _moviePlayerController.controlStyle = <span class="built_in">MPMovieControlStyleEmbedded</span>;</div><div class="line">        _moviePlayerController.scalingMode = <span class="built_in">MPMovieScalingModeAspectFit</span>;</div><div class="line">        [_moviePlayerController.view setTranslatesAutoresizingMaskIntoConstraints:<span class="literal">NO</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _moviePlayerController;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>_moviePlayerController.view 一定要添加到父视图上, 要不只有声音没有图片</li><li>MPMoviePlayerController 继承 NSObject <mpmediaplayback></mpmediaplayback></li><li><mpmediaplayback> 播放, 暂停, 停止, 准备播放的API</mpmediaplayback></li><li>视图刚呈现时底部显示: 暂停 进度条 全屏按钮</li><li>点击底部全屏按钮后会在顶部呈现: Done 进度条 退出全屏按钮</li></ul><h2 id="2-顶部-Done-和-退出全屏按钮的监测"><a href="#2-顶部-Done-和-退出全屏按钮的监测" class="headerlink" title="2. 顶部 Done 和 退出全屏按钮的监测"></a>2. 顶部 Done 和 退出全屏按钮的监测</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(doneButtonClick:) name:<span class="built_in">MPMoviePlayerWillExitFullscreenNotification</span> object:<span class="literal">nil</span>];</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)doneButtonClick:(<span class="built_in">NSNotification</span> *)center</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.moviePlayerController.playbackState == <span class="built_in">MPMoviePlaybackStateStopped</span>) &#123;</div><div class="line">        <span class="comment">//说明是点击Done按钮</span></div><div class="line">        [<span class="keyword">self</span> dismissViewControllerAnimated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>.moviePlayerController.playbackState == <span class="built_in">MPMoviePlaybackStatePlaying</span>)&#123;</div><div class="line">        <span class="comment">//说明点击了右上角退出全屏按钮</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>注册 <code>MPMoviePlayerWillExitFullscreenNotification</code> 这个通知, 不管是点击Done还是退出全屏按钮都会接受到通知, 在通知的回调方法中可以根据 <code>playbackState</code> 这个属性来判断是点击那个按钮.</li><li>点击Done按钮时会暂停播放</li><li>点击退出全屏按钮则不会暂停播放</li></ul><h2 id="3-监听视频播放结束"><a href="#3-监听视频播放结束" class="headerlink" title="3. 监听视频播放结束"></a>3. 监听视频播放结束</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-attr">[[NSNotificationCenter defaultCenter]</span> <span class="selector-tag">addObserver</span><span class="selector-pseudo">:self</span> <span class="selector-tag">selector</span>:@<span class="selector-tag">selector</span>(<span class="attribute">videoEndPlay</span>:) <span class="selector-tag">name</span><span class="selector-pseudo">:MPMoviePlayerPlaybackDidFinishNotification</span> <span class="selector-tag">object</span><span class="selector-pseudo">:nil</span>];</div><div class="line"></div><div class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">videoEndPlay</span><span class="selector-pseudo">:(NSNotification</span> *)<span class="selector-tag">sender</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"播放结束"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><ul><li>自动播放完成后会调用</li><li>用户退出播放时会调用</li></ul><h2 id="4-监听当前视频播放状态"><a href="#4-监听当前视频播放状态" class="headerlink" title="4. 监听当前视频播放状态"></a>4. 监听当前视频播放状态</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(videoLoadStateDidChange:) name:<span class="built_in">MPMoviePlayerLoadStateDidChangeNotification</span> object:<span class="literal">nil</span>];</div><div class="line">- (<span class="keyword">void</span>)videoLoadStateDidChange:(<span class="built_in">NSNotification</span> *)sender</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Returns the network load state of the movie player</span></div><div class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.moviePlayerController.loadState) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMovieLoadStatePlayable</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"加载完成,可以播放"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMovieLoadStatePlaythroughOK</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"缓冲完成，可以连续播放"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMovieLoadStateStalled</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"缓冲中"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMovieLoadStateUnknown</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"未知状态"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="5-监听当前视频-Playback-拖动进度条-播放-暂停-开启全屏-退出全屏也需要注册这个通知"><a href="#5-监听当前视频-Playback-拖动进度条-播放-暂停-开启全屏-退出全屏也需要注册这个通知" class="headerlink" title="5. 监听当前视频 Playback 拖动进度条, 播放, 暂停, 开启全屏, 退出全屏也需要注册这个通知"></a>5. 监听当前视频 Playback 拖动进度条, 播放, 暂停, 开启全屏, 退出全屏也需要注册这个通知</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(videoPlaybackDidChange:) name:<span class="built_in">MPMoviePlayerPlaybackStateDidChangeNotification</span> object:<span class="literal">nil</span>];</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)videoPlaybackDidChange:(<span class="built_in">NSNotification</span> *)center</div><div class="line">&#123;</div><div class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.moviePlayerController.playbackState) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMoviePlaybackStateStopped</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"停止播放"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMoviePlaybackStatePlaying</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"正在播放"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMoviePlaybackStatePaused</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"暂停播放"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMoviePlaybackStateInterrupted</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"中断播放"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMoviePlaybackStateSeekingForward</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"快进"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> <span class="built_in">MPMoviePlaybackStateSeekingBackward</span>:</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"快退"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="7-上一首-下一首"><a href="#7-上一首-下一首" class="headerlink" title="7. 上一首, 下一首"></a>7. 上一首, 下一首</h2><h2 id="8"><a href="#8" class="headerlink" title="8."></a>8.</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;首先贴上&lt;a href=&quot;https://developer.apple.com/documentation/mediaplayer/mpmovieplayercontroller&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="AVFoundation" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/AVFoundation/"/>
    
      <category term="MoviePlayer" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/AVFoundation/MoviePlayer/"/>
    
      <category term="MPMoviePlayerController" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/AVFoundation/MoviePlayer/MPMoviePlayerController/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>copy</title>
    <link href="https://github.com/songMW/stack.github.io/2017/07/03/Objective-C/copy/"/>
    <id>https://github.com/songMW/stack.github.io/2017/07/03/Objective-C/copy/</id>
    <published>2017-07-03T06:54:15.000Z</published>
    <updated>2018-01-25T07:35:12.933Z</updated>
    
    <content type="html"><![CDATA[<h2 id="strong"><a href="#strong" class="headerlink" title="strong"></a><code>strong</code></h2><p><code>@property (nonatomic,strong)NSString *name;</code><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)test1</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSMutableString</span> *str = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@"iOS"</span>];</div><div class="line">    </div><div class="line">    <span class="comment">// str value: iOS , str address: 0x17026fb00</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str value: %@ , str address: %p"</span>, str, str);</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.name = name;</div><div class="line">    <span class="comment">// self.name value: iOS , self.name address: 0x17026fb00</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self.name value: %@ , self.name address: %p"</span>, <span class="keyword">self</span>.name, <span class="keyword">self</span>.name);</div><div class="line">    </div><div class="line">    [str appendString:<span class="string">@" Source Probe"</span>];</div><div class="line">    <span class="comment">// self.name value: iOS Source Probe , self.name address: 0x17026fb00</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self.name value: %@ , self.name address: %p"</span>, <span class="keyword">self</span>.name, <span class="keyword">self</span>.name);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>对 <code>strong</code> 类型的变量进行赋值时，<code>name</code> 指向 <code>str</code> 的地址，<code>name</code> 的值会随着  <code>str</code> 的变化而变化。</p><h2 id="copy"><a href="#copy" class="headerlink" title="copy"></a><code>copy</code></h2><p><code>@property (nonatomic,copy)NSString *cy_name;</code></p><h3 id="指向不可变类型"><a href="#指向不可变类型" class="headerlink" title="指向不可变类型"></a>指向不可变类型</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)test2</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *str = <span class="string">@"iOS"</span>;</div><div class="line">    <span class="comment">// str value: iOS , str address: 0x17026fb80</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str value: %@ , str address: %p"</span>, str, str);</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.cy_name = str;</div><div class="line">    <span class="comment">// self.cy_name value: iOS , self.cy_name address: 0x17026fb80</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self.cy_name value: %@ , self.cy_name address: %p"</span>, <span class="keyword">self</span>.cy_name, <span class="keyword">self</span>.cy_name);</div><div class="line"></div><div class="line">    str = <span class="string">@" Source Probe"</span>;</div><div class="line">    <span class="comment">// self.cy_name value: iOS , self.cy_name address: 0x17026fb80</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self.cy_name value: %@ , self.cy_name address: %p"</span>, <span class="keyword">self</span>.cy_name, <span class="keyword">self</span>.cy_name);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>对 <code>copy</code> 类型的变量进行赋值时，<code>cy_name</code> 指向  <code>str</code>  的地址，<code>cy_name</code> 的值不会随着  <code>str</code> 的变化而变化。</p><h3 id="指向可变类型"><a href="#指向可变类型" class="headerlink" title="指向可变类型"></a>指向可变类型</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)test3</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSMutableString</span> *str = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@"iOS"</span>];</div><div class="line">    <span class="comment">// str value: iOS , str address: 0x170270300</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str value: %@ , str address: %p"</span>, str, str);</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.cy_name = str;</div><div class="line">    <span class="comment">// self.cy_name value: iOS , self.cy_name address: 0xa00000000534f693</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self.cy_name value: %@ , self.cy_name address: %p"</span>, <span class="keyword">self</span>.cy_name, <span class="keyword">self</span>.cy_name);</div><div class="line"></div><div class="line">    [str appendString:<span class="string">@" Source Probe"</span>];</div><div class="line">    <span class="comment">// self.cy_name value: iOS , self.cy_name address: 0xa00000000534f693</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"self.cy_name value: %@ , self.cy_name address: %p"</span>, <span class="keyword">self</span>.cy_name, <span class="keyword">self</span>.cy_name);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>对 <code>copy</code> 类型的变量进行赋值时，<code>cy_name</code> 指向新的地址，<code>cy_name</code> 的值不会随着  <code>str</code> 的变化而变化。</p><p><code>copy</code>  针对可变类型的变量时，地址会发生变化。</p><h2 id="mutableCopy"><a href="#mutableCopy" class="headerlink" title="mutableCopy"></a><code>mutableCopy</code></h2><h3 id="指向不可变类型-1"><a href="#指向不可变类型-1" class="headerlink" title="指向不可变类型"></a>指向不可变类型</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>) test7</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *str = <span class="string">@"iOS"</span>;</div><div class="line">    <span class="comment">// str value: iOS , str address: 0x170263c00</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str value: %@ , str address: %p"</span>, str, str);</div><div class="line"></div><div class="line">    <span class="built_in">NSString</span> *str_b = [str mutableCopy];</div><div class="line">    <span class="comment">// str_b value: iOS , str_b address: 0x1702638c0</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str_b value: %@ , str_b address: %p"</span>, str_b, str_b);</div><div class="line"></div><div class="line">    str = <span class="string">@"Android"</span>;</div><div class="line">    <span class="comment">// str_b value: iOS , str_b address: 0x1702638c0</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str_b value: %@ , str_b address: %p"</span>, str_b, str_b);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>对一个不可变字符串进行深拷贝时，地址发生变化，值不会在改变。</p><h3 id="指向可变类型-1"><a href="#指向可变类型-1" class="headerlink" title="指向可变类型"></a>指向可变类型</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>) test6</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSMutableString</span> *str = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@"iOS"</span>];</div><div class="line">    <span class="comment">// str value: iOS , str address: 0x170263c00</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str value: %@ , str address: %p"</span>, str, str);</div><div class="line"></div><div class="line">    <span class="built_in">NSString</span> *str_b = [str mutableCopy];</div><div class="line">    <span class="comment">// str_b value: iOS , str_b address: 0x1702638c0</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str_b value: %@ , str_b address: %p"</span>, str_b, str_b);</div><div class="line"></div><div class="line">    [str appendString:<span class="string">@" Source Probe"</span>];</div><div class="line">    <span class="comment">// str_b value: iOS , str_b address: 0x1702638c0</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"str_b value: %@ , str_b address: %p"</span>, str_b, str_b);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>对一个可变字符串进行深拷贝时，地址发生变化，值不会在改变。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>对于系统的非容器类对象，如果对一不可变对象 <code>NSString</code> 复制，<code>copy</code> 是指针复制(浅拷贝) ，<code>mutableCopy</code> 是对象复制(深拷贝)； 如果是对可变对象 <code>NSMutableString</code> 复制，<code>copy</code> 和 <code>mutableCopy</code> 都是深拷贝，但是 <code>copy</code>  返回的对象是不可变的；</li><li>对于系统的容器类对象，对不可变对象 <code>NSArray</code> 进行复制，<code>copy</code> 是指针复制(浅拷贝)，<code>mutableCopy</code> 是对象复制(深拷贝)， 但是不管是 <code>copy</code> 还是 <code>mutableCopy</code>，返回的容器内对象都是指针复制(浅拷贝)；</li><li>对于系统的容器类对象，对可变对象 <code>NSMutableArray</code> 进行复制时，<code>copy</code>  和 <code>mutableCopy</code> 都是对象复制(深拷贝)，但是不管是 <code>copy</code> 还是 <code>mutableCopy</code>，返回的容器内对象都是指针复制(浅拷贝)。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;strong&quot;&gt;&lt;a href=&quot;#strong&quot; class=&quot;headerlink&quot; title=&quot;strong&quot;&gt;&lt;/a&gt;&lt;code&gt;strong&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;&lt;code&gt;@property (nonatomic,strong)NSStrin
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="KnowledgeLists" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/KnowledgeLists/"/>
    
      <category term="copy" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/KnowledgeLists/copy/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>WKWebView的坑</title>
    <link href="https://github.com/songMW/stack.github.io/2017/06/18/Objective-C/WKWebView/"/>
    <id>https://github.com/songMW/stack.github.io/2017/06/18/Objective-C/WKWebView/</id>
    <published>2017-06-18T03:05:05.000Z</published>
    <updated>2018-05-10T07:23:05.584Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一-iOS-8-系统下遇到的问题"><a href="#一-iOS-8-系统下遇到的问题" class="headerlink" title="一: iOS 8 系统下遇到的问题"></a>一: iOS 8 系统下遇到的问题</h2><ol><li>实例化WKWebView后如果不将其添加到父类上, 则其代理方法不回调; iOS 9及以上版本不存在此问题. 大坑~</li></ol><h2 id="二-webView-自适应宽度"><a href="#二-webView-自适应宽度" class="headerlink" title="二: webView 自适应宽度"></a>二: webView 自适应宽度</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (void)webViewDidFinishLoad:(UIWebView *)webView</div><div class="line">&#123;</div><div class="line">    // webView 自适应宽度</div><div class="line">    NSString *<span class="attr">meta</span> = [NSString stringWithFormat:@<span class="string">"document.getElementsByName(\"</span>viewport\<span class="string">")[0].content = \"</span><span class="attr">width=%f,initial-scale=1.0,</span> <span class="attr">minimum-scale=1.0,</span> <span class="attr">maximum-scale=1.0,</span> <span class="attr">user-scalable=no\"",</span> webView.frame.size.width];</div><div class="line">    [webView stringByEvaluatingJavaScriptFromString:meta];</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;一-iOS-8-系统下遇到的问题&quot;&gt;&lt;a href=&quot;#一-iOS-8-系统下遇到的问题&quot; class=&quot;headerlink&quot; title=&quot;一: iOS 8 系统下遇到的问题&quot;&gt;&lt;/a&gt;一: iOS 8 系统下遇到的问题&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;实例化WKW
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="WKWebView" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/WKWebView/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
  <entry>
    <title>KVO</title>
    <link href="https://github.com/songMW/stack.github.io/2017/06/10/Objective-C/KV_X/KVO/"/>
    <id>https://github.com/songMW/stack.github.io/2017/06/10/Objective-C/KV_X/KVO/</id>
    <published>2017-06-10T02:15:23.000Z</published>
    <updated>2018-05-22T07:34:50.024Z</updated>
    
    <content type="html"><![CDATA[<h2 id="什么是KVO"><a href="#什么是KVO" class="headerlink" title="什么是KVO?"></a><em>什么是KVO?</em></h2><p><code>Key-value observing is a mechanism that allows objects to be notified of changes to specified properties of other objects.</code><br><strong> KVO是一种机制，被观察对象指定的属性发生变化时，观察者可以得到通知。</strong><br><code>Important: In order to understand key-value observing, you must first understand key-value coding.</code></p><h3 id="注册观察者"><a href="#注册观察者" class="headerlink" title="注册观察者"></a>注册观察者</h3><ol><li>addObserver ：注册观察者</li><li>forKeyPath ：需要观察对象的属性</li><li>NSKeyValueObservingOptions ：当观察对象的属性值发生变化时，会发送一个通知包含 <code>NSKeyValueChangeNewKey and NSKeyValueChangeOldKey</code></li><li>content ：用于标识KVO，移除特定的KVO</li></ol><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AdHubKVOModel *testModel = [[AdHubKVOModel alloc]init];</div><div class="line">[testModel addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"keyPath"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</div></pre></td></tr></table></figure><h3 id="触发回调"><a href="#触发回调" class="headerlink" title="触发回调"></a>触发回调</h3><p>设置 testModel.keyPath = @”20”;时会触发回调通知<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context</div><div class="line">&#123;</div><div class="line">    <span class="comment">// keyPath ：观察对象的属性</span></div><div class="line">    <span class="comment">// object  ：被观察的对象</span></div><div class="line">    <span class="comment">// change  ：包含 NSKeyValueChangeNewKey and NSKeyValueChangeOldKey</span></div><div class="line">                change[<span class="built_in">NSKeyValueChangeNewKey</span>] / change[<span class="built_in">NSKeyValueChangeOldKey</span>]</div><div class="line">    <span class="comment">// context ：用于标识KVO，移除特定的KVO</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h3 id="自动通知"><a href="#自动通知" class="headerlink" title="自动通知"></a>自动通知</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Call the accessor method.</span></div><div class="line">[account setName:<span class="string">@"Savings"</span>];</div><div class="line"></div><div class="line"><span class="comment">// Use setValue:forKey:.</span></div><div class="line">[account setValue:<span class="string">@"Savings"</span> forKey:<span class="string">@"name"</span>];</div><div class="line"></div><div class="line"><span class="comment">// Use a key path, where 'account' is a kvc-compliant property of 'document'.</span></div><div class="line">[document setValue: <span class="string">@"Savings"</span> forKeyPath:<span class="string">@"account.name"</span>];</div><div class="line"></div><div class="line"><span class="comment">// Use mutableArrayValueForKey: to retrieve a relationship proxy object.</span></div><div class="line">Transaction *newTransaction = &lt;<span class="meta">#Create a new transaction for the account#&gt;;</span></div><div class="line"><span class="built_in">NSMutableArray</span> *transactions = [account mutableArrayValueForKey:<span class="string">@"transactions"</span>];</div><div class="line">[transactions addObject:newTransaction];</div></pre></td></tr></table></figure><h3 id="手动通知"><a href="#手动通知" class="headerlink" title="手动通知"></a>手动通知</h3><p>需要重写<code>NSKeyValueObserving.h</code>中的方法, 判断当观察的 <code>key</code> 是 <code>balance</code> 时，就将自动通知关闭，其余的情况还是根据父类来进行判断<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)theKey </div><div class="line">&#123;</div><div class="line">    <span class="built_in">BOOL</span> automatic = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">if</span> ([theKey isEqualToString:<span class="string">@"balance"</span>]) &#123;</div><div class="line">        automatic = <span class="literal">NO</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        automatic = [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:theKey];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> automatic;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><strong> 返回YES时会自动调用 <code>-willChangeValueForKey:/-didChangeValueForKey:</code> 这两个方法；</strong><br><strong> 返回NO时需要手动设置 <code>-willChangeValueForKey:/-didChangeValueForKey:</code> 这两个方法。</strong></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setBalance:(<span class="keyword">double</span>)theBalance</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (theBalance != _balance) &#123;</div><div class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"balance"</span>];</div><div class="line">        _balance = theBalance;</div><div class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"balance"</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="同时设置多个属性值"><a href="#同时设置多个属性值" class="headerlink" title="同时设置多个属性值"></a>同时设置多个属性值</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setBalance:(<span class="keyword">double</span>)theBalance </div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"balance"</span>];</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"itemChanged"</span>];</div><div class="line">    _balance = theBalance;</div><div class="line">    _itemChanged = _itemChanged+<span class="number">1</span>;</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"itemChanged"</span>];</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"balance"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="移除KVO"><a href="#移除KVO" class="headerlink" title="移除KVO"></a>移除KVO</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[observeredObject removeObserver:observer forKeyPath:keyPath];</div></pre></td></tr></table></figure><p><strong>再次移除同一对象的同一属性会crash</strong><br><code>Terminating app due to uncaught exception &#39;NSRangeException&#39;, reason: &#39;Cannot remove an observer &lt;xxxxx 0x7f9310e0bec0&gt; for the key path &quot;keyPath&quot; from &lt;xxxx 0x600000648c70&gt; because it is not registered as an observer.</code></p><p><strong> 移除KVO时，注意：<code>forKeyPath</code>  传入 </strong></p><ul><li>不能为空</li><li>不能是观察对象中不存在的属性</li><li>不能是未被注册观察的属性</li><li>不能重复移除一个属性<br>以上会造成crash：<br><code>Terminating app due to uncaught exception &#39;NSRangeException&#39;, reason: &#39;-[__NSCFConstantString characterAtIndex:]: Range or index out of bounds</code></li></ul><h2 id="原理是什么？"><a href="#原理是什么？" class="headerlink" title="原理是什么？"></a><strong>原理是什么？</strong></h2><p><code>Automatic key-value observing is implemented using a technique called isa-swizzling. The isa pointer, as the name suggests, points to the object&#39;s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance. You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.</code></p><h3 id="创建一个实例"><a href="#创建一个实例" class="headerlink" title="创建一个实例"></a>创建一个实例</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AdHubKVOModel *testModel = [[AdHubKVOModel alloc]init];</div></pre></td></tr></table></figure><p>打印 testModel 可以发现 :<br><code>&lt;AdHubKVOModel: 0x60400044c390&gt;</code><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="built_in">NSObject</span>) <span class="built_in">NSObject</span> = &#123;</div><div class="line">    isa = AdHubKVOModel</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>testModel 是AdHubKVOModel 的实例，其isa指针指向AdHubKVOModel</p><h3 id="执行注册观察者的方法"><a href="#执行注册观察者的方法" class="headerlink" title="执行注册观察者的方法:"></a>执行注册观察者的方法:</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[testModel addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"keyPath"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</div></pre></td></tr></table></figure><p>再次打印 testModel 可以发现：<br><code>&lt;AdHubKVOModel: 0x60400044c390&gt;</code><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="built_in">NSObject</span>) <span class="built_in">NSObject</span> = &#123;</div><div class="line">    isa = <span class="built_in">NSKVONotifying_AdHubKVOModel</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><code>NSKVONotifying_AdHubKVOModel</code> 是什么？苹果的文档中提起对对象的属性注册观察者时，会对所观察的对象的isa指针进行修改，此时isa指针指向一个中间类，而不是一个真实的类，创建一个以<code>NSKVONotifying_</code>开头的的类名。<br>在这个类中，系统为我们重写了被观察属性的 setter 方法。</p><h3 id="KVO是如何寻找被观察属性的？"><a href="#KVO是如何寻找被观察属性的？" class="headerlink" title="KVO是如何寻找被观察属性的？"></a>KVO是如何寻找被观察属性的？</h3><ol><li>属性对象第一次被观察时，系统会自动生成一个以<code>NSKVONotifying_</code>开头的派生类，并在这个派生类中重写被观察属性的 <code>setter</code> 方法，在 <code>setter</code> 方法内实现通知回调机制；</li><li>每个对象都有一个isa指针指向对象所在类，当一个类对象被首次观察时，会将 <code>isa</code> 指针指向派生类，这点在上文中已经验证过，在派生类中的 <code>setter</code> 方法中真正的实现赋值；</li><li>在派生类中会实现两个方法 <code>willChangeValueForKey:</code> 和 <code>didChangevlueForKey:</code> 其中<code>willChangeValueForKey:</code> 记录旧值；<code>didChangevlueForKey:</code> 记录新值；</li><li>紧接着<code>observeValueForKey:ofObject:change:context:</code> 被调用，此时即可获取到被观察属性值的变化。</li><li>如果在当前类中未找到要监测的属性，则会向当前类的父类中查找。。。一直找下去，找到执行第一步；没有找到，则不会触发通知回调。</li></ol><h3 id="限制条件是什么？"><a href="#限制条件是什么？" class="headerlink" title="限制条件是什么？"></a>限制条件是什么？</h3><h4 id="一：forKeyPath-为实例对象是否可以？"><a href="#一：forKeyPath-为实例对象是否可以？" class="headerlink" title="一：forKeyPath 为实例对象是否可以？"></a><em>一：<code>forKeyPath</code> 为实例对象是否可以？</em></h4><p>可以，但KVO不会触发回调通知。<br>如果手动创建一个该实例的setter方法，可以触发回调，因为KVO监测的是被监测对象属性的 <code>setter</code> 方法。<br>如果手动创建一个该实例的非setter方法，需要调用 <code>willChangeValueForKey 和 didChangeValueForKey</code> 触发回调。</p><h4 id="二：forKeyPath-为不存在的实例对象是否可以？"><a href="#二：forKeyPath-为不存在的实例对象是否可以？" class="headerlink" title="二：forKeyPath 为不存在的实例对象是否可以？"></a><em>二：<code>forKeyPath</code> 为不存在的实例对象是否可以？</em></h4><p>可以，但KVO不会触发回调通知。</p><h4 id="三：forKeyPath-为空-nil-时是否可以？"><a href="#三：forKeyPath-为空-nil-时是否可以？" class="headerlink" title="三：forKeyPath 为空 / nil 时是否可以？"></a><em>三：<code>forKeyPath</code> 为空 / nil 时是否可以？</em></h4><p><code>会造成crash：Terminating app due to uncaught exception &#39;NSRangeException&#39;, reason: &#39;-[__NSCFConstantString characterAtIndex:]: Range or index out of bounds</code></p><h4 id="四：-forKeyPath-为方法名是否可以？"><a href="#四：-forKeyPath-为方法名是否可以？" class="headerlink" title="四： forKeyPath 为方法名是否可以？"></a><em>四： <code>forKeyPath</code> 为方法名是否可以？</em></h4><p>可以，但KVO不会触发回调通知。</p><h4 id="五：同一个类中注册多个KVO会怎么样？"><a href="#五：同一个类中注册多个KVO会怎么样？" class="headerlink" title="五：同一个类中注册多个KVO会怎么样？"></a><em>五：同一个类中注册多个KVO会怎么样？</em></h4><p>所有的回调都是走同一个回调方法，需要对触发回调函数的来源进行判断。</p><h4 id="六：被观察类的父类中也实现了KVO会怎么样？"><a href="#六：被观察类的父类中也实现了KVO会怎么样？" class="headerlink" title="六：被观察类的父类中也实现了KVO会怎么样？"></a><em>六：被观察类的父类中也实现了KVO会怎么样？</em></h4><p>比如被观察类A，其父类为superA，superA中也实现了KVO，那么在C类中添加对A类的某个属性的观察，会怎么样？<br>被观察属性值都发生变化，先走C类中的回调方法，然后在走superA类中的回调方法。</p><p>总结： <code>forKeyPath</code> 不能为空，否则会crash，找不到则不会出发通知。</p><h2 id="模拟实现系统KVO"><a href="#模拟实现系统KVO" class="headerlink" title="模拟实现系统KVO"></a>模拟实现系统KVO</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^HBKVOCallBack)(<span class="built_in">NSDictionary</span> *info);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> HBKeyValueChangeKey = <span class="string">@"HBKeyValueChangeKey"</span>;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> HBKeyValueChangeNewKey = <span class="string">@"HBKeyValueChangeNewKey"</span>;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> HBKeyValueChangeOldKey = <span class="string">@"HBKeyValueChangeOldKey"</span>;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> HBKeyValueObserver = <span class="string">@"HBKeyValueObserver"</span>;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> HBKeyValueKeyPath = <span class="string">@"HBKeyValueKeyPath"</span>;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> HBKeyValueContent = <span class="string">@"HBKeyValueContent"</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">HBHookKVO</span>)</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)HB_addObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="built_in">NSString</span> *)content KVOCallBackBlock:(HBKVOCallBack)block;</div><div class="line">- (<span class="keyword">void</span>)HB_removeObserverAllPath:(<span class="built_in">NSObject</span> *)observer;</div><div class="line">- (<span class="keyword">void</span>)HB_removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</div><div class="line">- (<span class="keyword">void</span>)HB_removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="built_in">NSString</span> *)content;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="meta">#import <span class="meta-string">"NSObject+HBHookKVO.h"</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="keyword">const</span> kObserver = <span class="string">"kObserver"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="keyword">const</span> kObserverKeyPath = <span class="string">"kObserverKeyPath"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="keyword">const</span> kKVOCallBackBlock = <span class="string">"kKVOCallBackBlock"</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> HBKVOClassPrefix = <span class="string">@"NSKVONotifying_"</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">HBHookKVO</span>)</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)HB_addObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="built_in">NSString</span> *)content KVOCallBackBlock:(HBKVOCallBack)block</div><div class="line">&#123;</div><div class="line">    <span class="comment">// 判断传入的keyPath是否存在</span></div><div class="line">    <span class="keyword">if</span> (!keyPath || !keyPath.length) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, kObserver, observer, OBJC_ASSOCIATION_ASSIGN);</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, kObserverKeyPath, keyPath, OBJC_ASSOCIATION_ASSIGN);</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, kKVOCallBackBlock, block, OBJC_ASSOCIATION_COPY_NONATOMIC);</div><div class="line"></div><div class="line">    <span class="comment">// 判断属性是否存在</span></div><div class="line">    SEL setterSel = [<span class="keyword">self</span> addNewSetterMethod:keyPath];</div><div class="line"></div><div class="line">    Class newClass = object_getClass(<span class="keyword">self</span>);</div><div class="line">    <span class="comment">// 判断当前类是否是KVO中间类</span></div><div class="line">    <span class="built_in">NSString</span> *className = <span class="built_in">NSStringFromClass</span>(newClass);</div><div class="line">    <span class="keyword">if</span> (![className containsString:HBKVOClassPrefix]) &#123;</div><div class="line">    <span class="comment">// 动态创建一个类</span></div><div class="line">        <span class="built_in">NSString</span> *newName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@%@"</span>, HBKVOClassPrefix, <span class="built_in">NSStringFromClass</span>(<span class="keyword">self</span>.class)];</div><div class="line">        Class kvoClass = <span class="built_in">NSClassFromString</span>(newName);</div><div class="line">        <span class="keyword">if</span> (!kvoClass) &#123;</div><div class="line">            newClass = objc_allocateClassPair(<span class="keyword">self</span>.class, newName.UTF8String, <span class="number">0</span>);</div><div class="line">            <span class="comment">// 注册这个类</span></div><div class="line">            objc_registerClassPair(newClass);</div><div class="line">            <span class="comment">// 改变isa指针</span></div><div class="line">            object_setClass(<span class="keyword">self</span>, newClass);</div><div class="line">            newClass = [<span class="keyword">self</span> <span class="keyword">class</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span>&#123;</div><div class="line">            object_setClass(<span class="keyword">self</span>, kvoClass);</div><div class="line">            newClass = kvoClass;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 判断对象的类是否重写过对象的setter方法</span></div><div class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> hasSelector:setterSel <span class="keyword">class</span>:<span class="keyword">self</span>.class]) &#123;</div><div class="line">        class_addMethod(newClass, setterSel, (IMP)kvo_setter, <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)HB_removeObserverAllPath:(<span class="built_in">NSObject</span> *)observer</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> HB_removeObserver:observer forKeyPath:<span class="literal">nil</span> context:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)HB_removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> HB_removeObserver:observer forKeyPath:keyPath context:<span class="literal">nil</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)HB_removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="built_in">NSString</span> *)content</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (![<span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]) hasPrefix:HBKVOClassPrefix]) <span class="keyword">return</span>;</div><div class="line">    object_setClass(<span class="keyword">self</span>, class_getSuperclass([<span class="keyword">self</span> <span class="keyword">class</span>]));</div><div class="line">    objc_removeAssociatedObjects(<span class="keyword">self</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (SEL)addNewSetterMethod:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">&#123;</div><div class="line">    SEL setterSel = <span class="built_in">NSSelectorFromString</span>(setterForVar(keyPath));</div><div class="line">    <span class="keyword">return</span> setterSel;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)hasSetterMethodWithKeyPath:(<span class="built_in">NSString</span> *)keyPath</div><div class="line">&#123;</div><div class="line">    <span class="built_in">BOOL</span> result = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">    <span class="comment">// 遍历当前类和其父类中的所有属性</span></div><div class="line">    Class <span class="keyword">class</span> = <span class="keyword">self</span>.class;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">class</span>) &#123;</div><div class="line">        objc_property_t *property = class_copyPropertyList(<span class="keyword">class</span>, &amp;count);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            objc_property_t t = property[i];</div><div class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *name = property_getName(t);</div><div class="line">            <span class="built_in">NSString</span> *key = [[<span class="built_in">NSString</span> alloc]initWithUTF8String:name];</div><div class="line">            <span class="keyword">if</span> ([key isEqualToString:keyPath]) &#123;</div><div class="line">                result = <span class="literal">YES</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (result)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">class</span> = class_getSuperclass(<span class="keyword">class</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)hasSelector:(SEL)sel <span class="keyword">class</span>:(Class)sClass</div><div class="line">&#123;</div><div class="line">    <span class="built_in">BOOL</span> result = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> methodCount = <span class="number">0</span>;</div><div class="line">    Method *methodList = class_copyMethodList(sClass, &amp;methodCount);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodCount; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (sel == method_getName(methodList[i])) &#123;</div><div class="line">            result = <span class="literal">YES</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#pragma mark - Core method</span></div><div class="line"><span class="keyword">void</span> kvo_setter(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSString</span> *key)&#123;</div><div class="line">    <span class="keyword">struct</span> objc_super superClass = &#123;</div><div class="line">        .receiver = <span class="keyword">self</span>,</div><div class="line">        .super_class = class_getSuperclass(object_getClass(<span class="keyword">self</span>))</div><div class="line">    &#125;;</div><div class="line">    ((<span class="keyword">void</span> (*)(<span class="keyword">void</span> *, SEL, <span class="keyword">id</span>))objc_msgSendSuper)(&amp;superClass, _cmd, key);</div><div class="line"></div><div class="line">    <span class="built_in">NSObject</span> *observer = objc_getAssociatedObject(<span class="keyword">self</span>, kObserver);</div><div class="line">    <span class="built_in">NSString</span> *keyPath = objc_getAssociatedObject(<span class="keyword">self</span>, kObserverKeyPath);</div><div class="line">    <span class="built_in">NSDictionary</span> *dict = @&#123;HBKeyValueKeyPath : keyPath, HBKeyValueObserver: observer, HBKeyValueChangeKey : @&#123;<span class="built_in">NSKeyValueChangeNewKey</span> : key&#125;, HBKeyValueContent : <span class="string">@""</span>&#125;;</div><div class="line">    HBKVOCallBack block = objc_getAssociatedObject(<span class="keyword">self</span>, kKVOCallBackBlock);</div><div class="line">    <span class="keyword">if</span> (block)</div><div class="line">        block(dict);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">NSString</span> *setterForVar(<span class="built_in">NSString</span> *keyPath)&#123;</div><div class="line">    <span class="built_in">NSString</span> *firstChar = [keyPath substringToIndex:<span class="number">1</span>];</div><div class="line">    <span class="keyword">if</span> ([firstChar isEqualToString:<span class="string">@"_"</span>]) &#123;</div><div class="line">        firstChar = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set%@:"</span>, keyPath];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        firstChar = firstChar.uppercaseString;</div><div class="line">        keyPath = [keyPath stringByReplacingCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>) withString:firstChar];</div><div class="line">        firstChar = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set%@:"</span>, keyPath];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> firstChar;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;什么是KVO&quot;&gt;&lt;a href=&quot;#什么是KVO&quot; class=&quot;headerlink&quot; title=&quot;什么是KVO?&quot;&gt;&lt;/a&gt;&lt;em&gt;什么是KVO?&lt;/em&gt;&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Key-value observing is a mechanism th
      
    
    </summary>
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/"/>
    
      <category term="KVO" scheme="https://github.com/songMW/stack.github.io/categories/Objective-C/KVO/"/>
    
    
      <category term="Objective-C" scheme="https://github.com/songMW/stack.github.io/tags/Objective-C/"/>
    
  </entry>
  
</feed>
