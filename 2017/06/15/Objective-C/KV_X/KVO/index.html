<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="null">
  <meta name="keyword" content="undefined">
  
    <link rel="icon" href="">
  
    
  <title>KVO | stack.blog</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.css" />
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>stack.blog</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>KVO</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2017年06月15日</time>
            
              | <i class="fa fa-folder-open-o" aria-hidden="true"></i> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Objective-C/">Objective-C</a>/ <a class="article-category-link" href="/categories/Objective-C/知识点/">知识点</a>/ <a class="article-category-link" href="/categories/Objective-C/知识点/KV-X/">KV_X</a>/ <a class="article-category-link" href="/categories/Objective-C/知识点/KV-X/KVO/">KVO</a>
  </div>



            
            
              | 
                  <i class="fa fa-tag" aria-hidden="true"></i>
                
               
  <a href="/tags/#Objective-C" class='tag'>Objective-C</a>


            
          </div>
          <h1 id="什么是KVO"><a href="#什么是KVO" class="headerlink" title="什么是KVO?"></a>什么是KVO?</h1><blockquote>
<p>Key-value observing is a mechanism that allows objects to be notified of changes to specified properties of other objects.</p>
</blockquote>
<p><strong> KVO是一种机制，被观察对象指定的属性发生变化时，观察者可以得到通知。</strong></p>
<blockquote>
<p>Important: In order to understand key-value observing, you must first understand key-value coding.</p>
</blockquote>
<h1 id="怎么用？"><a href="#怎么用？" class="headerlink" title="怎么用？"></a>怎么用？</h1><h2 id="注册观察者"><a href="#注册观察者" class="headerlink" title="注册观察者"></a>注册观察者</h2><ol>
<li>addObserver ：注册观察者</li>
<li>forKeyPath ：需要观察对象的属性</li>
<li>NSKeyValueObservingOptions ：当观察对象的属性值发生变化时，会发送一个通知包含 <code>NSKeyValueChangeNewKey and NSKeyValueChangeOldKey</code></li>
<li>content ：用于标识KVO，移除特定的KVO</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AdHubKVOModel *testModel = [[AdHubKVOModel alloc]init];</div><div class="line">[testModel addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"keyPath"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</div></pre></td></tr></table></figure>
<h2 id="触发回调"><a href="#触发回调" class="headerlink" title="触发回调"></a>触发回调</h2><p>设置 testModel.keyPath = @”20”;时会触发回调通知<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context</div><div class="line">&#123;</div><div class="line">    // keyPath ：观察对象的属性</div><div class="line">    // object  ：被观察的对象</div><div class="line">    // change  ：包含 NSKeyValueChangeNewKey and NSKeyValueChangeOldKey</div><div class="line">                change[NSKeyValueChangeNewKey] / change[NSKeyValueChangeOldKey]</div><div class="line">    // context ：用于标识KVO，移除特定的KVO</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="自动通知"><a href="#自动通知" class="headerlink" title="自动通知"></a>自动通知</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Call the accessor method.</span></div><div class="line">[account setName:<span class="string">@"Savings"</span>];</div><div class="line"></div><div class="line"><span class="comment">// Use setValue:forKey:.</span></div><div class="line">[account setValue:<span class="string">@"Savings"</span> forKey:<span class="string">@"name"</span>];</div><div class="line"></div><div class="line"><span class="comment">// Use a key path, where 'account' is a kvc-compliant property of 'document'.</span></div><div class="line">[document setValue: <span class="string">@"Savings"</span> forKeyPath:<span class="string">@"account.name"</span>];</div><div class="line"></div><div class="line"><span class="comment">// Use mutableArrayValueForKey: to retrieve a relationship proxy object.</span></div><div class="line">Transaction *newTransaction = &lt;<span class="meta">#Create a new transaction for the account#&gt;;</span></div><div class="line"><span class="built_in">NSMutableArray</span> *transactions = [account mutableArrayValueForKey:<span class="string">@"transactions"</span>];</div><div class="line">[transactions addObject:newTransaction];</div></pre></td></tr></table></figure>
<h2 id="手动通知"><a href="#手动通知" class="headerlink" title="手动通知"></a>手动通知</h2><p>需要重写<code>NSKeyValueObserving.h</code>中的方法, 判断当观察的 key 是 balance 时，就将自动通知关闭，其余的情况还是根据父类来进行判断<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)theKey &#123;</div><div class="line">    <span class="built_in">BOOL</span> automatic = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">if</span> ([theKey isEqualToString:<span class="string">@"balance"</span>]) &#123;</div><div class="line">        automatic = <span class="literal">NO</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        automatic = [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:theKey];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> automatic;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong> 返回YES时会自动调用 <code>-willChangeValueForKey:/-didChangeValueForKey:</code> 这两个方法；</strong><br><strong> 返回NO时需要手动设置 <code>-willChangeValueForKey:/-didChangeValueForKey:</code> 这两个方法。</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setBalance:(<span class="keyword">double</span>)theBalance &#123;</div><div class="line">    <span class="keyword">if</span> (theBalance != _balance) &#123;</div><div class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"balance"</span>];</div><div class="line">        _balance = theBalance;</div><div class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"balance"</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="同时设置多个属性值"><a href="#同时设置多个属性值" class="headerlink" title="同时设置多个属性值"></a>同时设置多个属性值</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setBalance:(<span class="keyword">double</span>)theBalance &#123;</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"balance"</span>];</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"itemChanged"</span>];</div><div class="line">    _balance = theBalance;</div><div class="line">    _itemChanged = _itemChanged+<span class="number">1</span>;</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"itemChanged"</span>];</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"balance"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h2><h2 id="移除KVO"><a href="#移除KVO" class="headerlink" title="移除KVO"></a>移除KVO</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[observeredObject removeObserver:observer forKeyPath:keyPath];</div></pre></td></tr></table></figure>
<p>再次移除同一对象的同一属性会crash;</p>
<blockquote>
<p>Terminating app due to uncaught exception ‘NSRangeException’, reason: ‘Cannot remove an observer <xxxxx 0x7f9310e0bec0=""> for the key path “keyPath” from <xxxx 0x600000648c70=""> because it is not registered as an observer.</xxxx></xxxxx></p>
</blockquote>
<p><strong> 移除KVO时， 注意：<code>forKeyPath</code>  传入 </strong></p>
<ul>
<li>不能为空</li>
<li>不能是观察对象中不存在的属性</li>
<li>不能是未被注册观察的属性<br>以上会造成crash：<blockquote>
<p><em>*</em> Terminating app due to uncaught exception ‘NSRangeException’, reason: ‘-[__NSCFConstantString characterAtIndex:]: Range or index out of bounds</p>
</blockquote>
</li>
</ul>
<h1 id="原理是什么？"><a href="#原理是什么？" class="headerlink" title="原理是什么？"></a>原理是什么？</h1><blockquote>
<p>Automatic key-value observing is implemented using a technique called isa-swizzling.</p>
<p>The isa pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.</p>
<p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.</p>
<p>You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.</p>
</blockquote>
<h2 id="创建一个实例"><a href="#创建一个实例" class="headerlink" title="创建一个实例"></a>创建一个实例</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AdHubKVOModel *testModel = [[AdHubKVOModel alloc]init];</div></pre></td></tr></table></figure>
<p>打印 testModel 可以发现 :</p>
<blockquote>
<p>Printing description of testModel:<br><code>&lt;AdHubKVOModel: 0x60400044c390&gt;</code></p>
<p>Printing description of testModel:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(<span class="built_in">NSObject</span>) <span class="built_in">NSObject</span> = &#123;</div><div class="line">    isa = AdHubKVOModel</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>testModel 是AdHubKVOModel 的实例，其isa指针指向AdHubKVOModel</p>
</blockquote>
<h2 id="执行注册观察者的方法"><a href="#执行注册观察者的方法" class="headerlink" title="执行注册观察者的方法:"></a>执行注册观察者的方法:</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[testModel addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"keyPath"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</div></pre></td></tr></table></figure>
<p>再次打印 testModel 可以发现：</p>
<blockquote>
<p>Printing description of testModel:<br><code>&lt;AdHubKVOModel: 0x60400044c390&gt;</code></p>
<p>Printing description of testModel:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(NSObject) NSObject = &#123;</div><div class="line">    isa = NSKVONotifying_AdHubKVOModel</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>testModel 是 AdHubKVOModel 的实例，其isa指针却指向 <code>NSKVONotifying_AdHubKVOModel</code></p>
</blockquote>
<p><code>NSKVONotifying_AdHubKVOModel</code> 是什么？苹果的文档中提起对对象的属性注册观察者时，会对所观察的对象的isa指针进行修改，此时isa指针指向一个中间类，而不是一个真实的类，创建一个以<code>NSKVONotifying_</code>开头的的类名。<br>在这个类中，系统为我们重写了被观察属性的 setter 方法。</p>
<h2 id="KVO是如何寻找被观察属性的？"><a href="#KVO是如何寻找被观察属性的？" class="headerlink" title="KVO是如何寻找被观察属性的？"></a>KVO是如何寻找被观察属性的？</h2><ol>
<li>属性对象第一次被观察时，系统会自动生成一个以<code>NSKVONotifying_</code>开头的派生类，并在这个派生类中重写被观察属性的setter方法，在setter方法内实现通知回调机制。</li>
<li>每个对象都有一个isa指针指向对象所在类，当一个类对象被首次观察时，会将isa指针指向派生类，这点在上文中已经验证过，在派生类中的setter方法中真正的实现赋值。</li>
<li>在派生类中会实现两个方法: <code>willChangeValueForKey:</code> 和 <code>didChangevlueForKey:</code>；<code>willChangeValueForKey:</code>记录旧的值，被观察对象的值改变后 <code>didChangeValueForKey:</code> 被调用， <code>observeValueForKey:ofObject:change:context:</code> 也会被调用。</li>
<li>如果在当前类中未找到要监测的属性，则会向当前类的父类中查找。。。一直找下去，找到执行第一步。没有找到，则不会触发通知回调。</li>
</ol>
<h2 id="限制条件是什么？"><a href="#限制条件是什么？" class="headerlink" title="限制条件是什么？"></a>限制条件是什么？</h2><h3 id="猜想一：-forKeyPath-为实例对象是否可以？"><a href="#猜想一：-forKeyPath-为实例对象是否可以？" class="headerlink" title="猜想一： forKeyPath 为实例对象是否可以？"></a><em>猜想一： forKeyPath 为实例对象是否可以？</em></h3><p>可以，但KVO不会触发回调通知。</p>
<h3 id="猜想二：如果手动为实例对象创建一个setter方法是否可以？"><a href="#猜想二：如果手动为实例对象创建一个setter方法是否可以？" class="headerlink" title="猜想二：如果手动为实例对象创建一个setter方法是否可以？"></a><em>猜想二：如果手动为实例对象创建一个setter方法是否可以？</em></h3><p>没错，是可以的，因为KVO监测的是被监测对象属性的setter方法。</p>
<h3 id="猜想三：forKeyPath-为空-nil-时是否可以？"><a href="#猜想三：forKeyPath-为空-nil-时是否可以？" class="headerlink" title="猜想三：forKeyPath 为空 / nil 时是否可以？"></a><em>猜想三：forKeyPath 为空 / nil 时是否可以？</em></h3><p>会造成crash：</p>
<blockquote>
<p><em>*</em> Terminating app due to uncaught exception ‘NSRangeException’, reason: ‘-[__NSCFConstantString characterAtIndex:]: Range or index out of bounds</p>
</blockquote>
<h3 id="猜想四：-forKeyPath-为不存在的实例对象是否可以？"><a href="#猜想四：-forKeyPath-为不存在的实例对象是否可以？" class="headerlink" title="猜想四： forKeyPath 为不存在的实例对象是否可以？"></a><em>猜想四： forKeyPath 为不存在的实例对象是否可以？</em></h3><p>可以，但KVO不会触发回调通知。</p>
<h3 id="猜想五：-forKeyPath-为方法名是否可以？"><a href="#猜想五：-forKeyPath-为方法名是否可以？" class="headerlink" title="猜想五： forKeyPath 为方法名是否可以？"></a><em>猜想五： forKeyPath 为方法名是否可以？</em></h3><p>可以，但KVO不会触发回调通知。</p>
<h3 id="猜想六：-同一个类中注册多个KVO会怎么样？"><a href="#猜想六：-同一个类中注册多个KVO会怎么样？" class="headerlink" title="猜想六： 同一个类中注册多个KVO会怎么样？"></a><em>猜想六： 同一个类中注册多个KVO会怎么样？</em></h3><p>所有的回调都是走同一个回调方法，需要对触发回调函数的来源进行判断。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context</div><div class="line">&#123;</div><div class="line">    // keyPath ：观察对象的属性, 可用于判断触发回调函数的来源</div><div class="line">    // object  ：被观察的对象</div><div class="line">    // change  ：包含 NSKeyValueChangeNewKey and NSKeyValueChangeOldKey</div><div class="line">    // context ：用于标识KVO，移除特定的KVO</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="猜想七：-被观察类的父类中也实现了KVO会怎么样？"><a href="#猜想七：-被观察类的父类中也实现了KVO会怎么样？" class="headerlink" title="猜想七： 被观察类的父类中也实现了KVO会怎么样？"></a><em>猜想七： 被观察类的父类中也实现了KVO会怎么样？</em></h3><p>比如被观察类A，其父类为superA，superA中也实现了KVO，那么在C类中添加对A类的某个属性的观察，会怎么样？<br>被观察属性值都发生变化，先走C类中的回调方法，然后在走superA类中的回调方法。</p>
<h2 id="模拟实现系统KVO"><a href="#模拟实现系统KVO" class="headerlink" title="模拟实现系统KVO"></a>模拟实现系统KVO</h2>
        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#什么是KVO"><span class="toc-number">1.</span> <span class="toc-text">什么是KVO?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#怎么用？"><span class="toc-number">2.</span> <span class="toc-text">怎么用？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#注册观察者"><span class="toc-number">2.1.</span> <span class="toc-text">注册观察者</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#触发回调"><span class="toc-number">2.2.</span> <span class="toc-text">触发回调</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自动通知"><span class="toc-number">2.3.</span> <span class="toc-text">自动通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#手动通知"><span class="toc-number">2.4.</span> <span class="toc-text">手动通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#同时设置多个属性值"><span class="toc-number">2.5.</span> <span class="toc-text">同时设置多个属性值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#依赖关系"><span class="toc-number">2.6.</span> <span class="toc-text">依赖关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#移除KVO"><span class="toc-number">2.7.</span> <span class="toc-text">移除KVO</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#原理是什么？"><span class="toc-number">3.</span> <span class="toc-text">原理是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建一个实例"><span class="toc-number">3.1.</span> <span class="toc-text">创建一个实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#执行注册观察者的方法"><span class="toc-number">3.2.</span> <span class="toc-text">执行注册观察者的方法:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KVO是如何寻找被观察属性的？"><span class="toc-number">3.3.</span> <span class="toc-text">KVO是如何寻找被观察属性的？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#限制条件是什么？"><span class="toc-number">3.4.</span> <span class="toc-text">限制条件是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#猜想一：-forKeyPath-为实例对象是否可以？"><span class="toc-number">3.4.1.</span> <span class="toc-text">猜想一： forKeyPath 为实例对象是否可以？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#猜想二：如果手动为实例对象创建一个setter方法是否可以？"><span class="toc-number">3.4.2.</span> <span class="toc-text">猜想二：如果手动为实例对象创建一个setter方法是否可以？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#猜想三：forKeyPath-为空-nil-时是否可以？"><span class="toc-number">3.4.3.</span> <span class="toc-text">猜想三：forKeyPath 为空 / nil 时是否可以？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#猜想四：-forKeyPath-为不存在的实例对象是否可以？"><span class="toc-number">3.4.4.</span> <span class="toc-text">猜想四： forKeyPath 为不存在的实例对象是否可以？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#猜想五：-forKeyPath-为方法名是否可以？"><span class="toc-number">3.4.5.</span> <span class="toc-text">猜想五： forKeyPath 为方法名是否可以？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#猜想六：-同一个类中注册多个KVO会怎么样？"><span class="toc-number">3.4.6.</span> <span class="toc-text">猜想六： 同一个类中注册多个KVO会怎么样？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#猜想七：-被观察类的父类中也实现了KVO会怎么样？"><span class="toc-number">3.4.7.</span> <span class="toc-text">猜想七： 被观察类的父类中也实现了KVO会怎么样？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模拟实现系统KVO"><span class="toc-number">3.5.</span> <span class="toc-text">模拟实现系统KVO</span></a></li></ol></li></ol>
        </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy; 2018 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.js"></script>


</body>
</html>
